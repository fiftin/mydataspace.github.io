---
layout: default
language: en
---
<div id="view" class="root_page" style="padding-bottom: 30px">
</div>

<script src="/vendor/remarkable.js"></script>

<script>
  (function() {

    var md = new Remarkable({
      html:         true,        // Enable HTML tags in source
      xhtmlOut:     false,        // Use '/' to close single tags (<br />)
      breaks:       false,        // Convert '\n' in paragraphs into <br>
      langPrefix:   'language-',  // CSS language prefix for fenced blocks
      linkify:      false,        // Autoconvert URL-like text to links

      // Enable some language-neutral replacement + quotes beautification
      typographer:  false,

      // Double + single quotes replacement pairs, when typographer enabled,
      // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
      quotes: '“”‘’',

      // Highlighter function. Should return escaped HTML,
      // or '' if the source string is not changed
      highlight: function (/*str, lang*/) { return ''; }
    });


    var regex = new RegExp(".*/([^?#]+)"),
      results = regex.exec(location.href);
    if (!results) {
      return;
    }

    var DATA = {
      root: results[1] === 'root' ? 'fiftin' : results[1],
      path: '',
      children: true
    };

    var TABS = {
      VIEW_TAB_README_LABEL: 'view__about',
      VIEW_TAB_VIEW_LABEL: 'view__view',
      VIEW_TAB_COMMENTS_LABEL: 'view__comments'
    };

    function getCommentHTML(commentData) {
      return '<div class="view__comment" data-id="' + commentData.path + '">' +
        '<div class="view__comment__header"><div class="view__comment__date">' + MDSCommon.humanizeDate(commentData.createdAt) + ' ago</div></div>' +
        '<div class="view__comment__text">' + commentData.fields.text + '</div>' +
        '<div class="view__comment__footer"></div>' +
      '</div>';
    }

    function initCounters() {
      var elem = document.getElementById('view__counters_likes');
      elem.addEventListener('click', function() {
        if (MDSCommon.isPresent(elem.getAttribute('data-like-path'))) {
          Mydataspace.entities.request('entities.delete', {
            root: DATA.root,
            path: elem.getAttribute('data-like-path')
          }).then(function() {
            document.getElementById('view__counters_likes_count').innerText =
              parseInt(document.getElementById('view__counters_likes_count').innerText) - 1;
          }, function(err) {
            alert(err);
          });
        } else {
          Mydataspace.entities.request('entities.create', {
            root: DATA.root,
            path: 'likes/' + MDSCommon.guid()
          }).then(function() {
            document.getElementById('view__counters_likes_count').innerText =
              parseInt(document.getElementById('view__counters_likes_count').innerText) + 1;
          }, function(err) {
            alert(err);
          });
        }
      });
    }

    function initTabs() {
      for (var tabID in TABS) {
        (function(tabID) {
          var tab = document.getElementById(tabID);
          tab.addEventListener('click', function(event) {
            event.preventDefault();
            for (var tid in TABS) {
              document.getElementById(tid).classList.remove('view__tab--active');
              document.getElementById(TABS[tid]).style.display = 'none';
            }
            tab.classList.add('view__tab--active');
            document.getElementById(TABS[tabID]).style.display = 'block';

            switch (tabID) {
              case 'VIEW_TAB_VIEW_LABEL':
                var codepen = document.getElementById('view__view').getAttribute('data-codepen');
                document.getElementById('view__view').innerHTML =
                  '<p data-height="560" data-theme-id="0" data-slug-hash="' + codepen + '" data-default-tab="result" data-user="mydataspace" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/mydataspace/pen/' + codepen + '/">' + codepen + '</a> by My Data Space (<a href="http://codepen.io/mydataspace">@mydataspace</a>) on <a href="http://codepen.io">CodePen</a>.</p>' +
                  '';

                var codepenScript = document.createElement('script');
                codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
                document.getElementById('view__view').appendChild(codepenScript);
                break;
              case 'VIEW_TAB_COMMENTS_LABEL':
                Mydataspace.entities.request('entities.get', { root: DATA.root, children: true, path: 'comments' }).then(function(data) {
                  var comments = document.getElementById('view__comments__list');
                  comments.innerHTML = '';
                  var html = '';
                  for (var i in data.children) {
                    html += getCommentHTML(data.children[i]);
                  }
                  comments.innerHTML = html;
                });
                break;
            }

          });
        })(tabID);
      }
    }

    function setRootView(data, yourownLikes) {
      $.ajax({ url: '/fragments/root-view.html', method: 'get' }).then(function(html) {
        var view = document.getElementById('view');
        var websiteURL = data.fields.websiteURL;
        var description = data.fields.description;
        var readme = data.fields.readme;
        var ava = data.fields.avatar;

        view.innerHTML = html;

        if (MDSCommon.isPresent(ava)) {
          ava = Mydataspace.options.apiURL + '/avatars/sm/' + ava + '.png';
        }
        document.getElementById('view__overview_image').src = ava || '/images/icons/root.svg';
        document.getElementById('view__title').innerText =
          data.fields.name || MDSCommon.getPathName(data.root);

        var tags = (data.fields.tags || '').split(' ').filter(function(tag) {
          return tag != null && tag != '';
        }).map(function(tag) {
          return '<a class="view__tag" href="/?q=%23' + tag + '" onclick="openSearch(\'' + tag + '\'); return false;">' + tag + '</a>';
        }).join(' ');

        document.getElementById('view__tags').innerHTML = tags || '';
        document.getElementById('view__data_link').href = '/#' + data.root;
        document.getElementById('view__data_link').classList.remove('hidden');

        if (tags && websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--large');
          document.getElementById('view__overview_image').classList.add('view__overview_image--large');
        } else if (tags || websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--medium');
          document.getElementById('view__overview_image').classList.add('view__overview_image--medium');
        }

        if (MDSCommon.isBlank(websiteURL)) {
          document.getElementById('view__websiteURL').style.display = 'none';
        } else {
          document.getElementById('view__websiteURL').style.display = 'inline';
          document.getElementById('view__websiteURL').innerText = websiteURL;
          document.getElementById('view__websiteURL').href = websiteURL;
        }

        if (MDSCommon.isBlank(description)) {
          if (MDSCommon.isBlank(websiteURL)) {
            document.getElementById('view__description').innerHTML = '<i>No description or README provided.</i>';
          }
        } else {
          document.getElementById('view__description').innerText = description;
        }

        if (MDSCommon.isBlank(readme)) {
          document.getElementById('view__readme').style.display = 'none';
        } else {
          document.getElementById('view__readme').style.display = 'block';
        }
        document.getElementById('view__readme').innerHTML = md.render(readme);

        document.getElementById('view__tabs').classList.remove('hidden');

        if (MDSCommon.isBlank(data.fields.codepen)) {
          document.getElementById('VIEW_TAB_VIEW_LABEL').style.display = 'none';
        } else {
          document.getElementById('view__view').setAttribute('data-codepen', data.fields.codepen);
        }

        for (var i in data.children) {
          var child = data.children[i];
          switch (child.path) {
            case 'likes':
              document.getElementById('view__counters_likes_count').innerText = child.numberOfChildren;
              break;
            case 'comments':
              document.getElementById('view__counters_comments_count').innerText = child.numberOfChildren;
              document.getElementById('view__tabs_comments_count').innerText = child.numberOfChildren;
              break;
            case 'views':
              document.getElementById('view__tabs_views_count').innerText = child.numberOfChildren;
              break;
          }
        }

        if (yourownLikes != null && yourownLikes.children.length > 0) {
          document.getElementById('view__counters_likes')
                  .setAttribute('data-like-path', yourownLikes.children[0].path);

        }

        initCounters();

        initTabs();
      });
    }

    return Promise.all([
      Mydataspace.entities.request('entities.get', DATA),
      Mydataspace.isLoggedIn() ? Mydataspace.entities.request('entities.getMyChildren', { root: DATA.root, path: 'likes' }) : null
    ]).then(function(results) {
      setRootView(results[0], results[1]);
    });
  })();
</script>