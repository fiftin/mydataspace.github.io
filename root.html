---
layout: default
language: en
---
<div id="view" class="root_page" style="padding-bottom: 30px">
</div>

<div id="delete_look_modal"
     class="modal fade"
     tabindex="-1"
     role="dialog"
     aria-labelledby="Delete View">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header new_look_modal__header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <div class="modal-title">Delete View</div>
      </div>
      <div class="modal-body new_look_modal__body">
        You really want to delete this view?
      </div>
      <div class="modal-footer new_look_modal__footer">
        <button class="btn btn-danger" data-dismiss="modal" id="delete_look_modal_button">Yes</button>
        <button class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


<div id="new_look_modal"
     class="modal fade"
     tabindex="-1"
     role="dialog"
     aria-labelledby="New View">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header new_look_modal__header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <div class="modal-title" id="new_look_modal_header">New View</div>
      </div>
      <div class="modal-body new_look_modal__body">
        <form class="bootstrap-form">
          <div class="form-group">
            <input type="text"
                   id="new_look_modal_title"
                   class="form-control"
                   placeholder="Title"
                   autofocus />
          </div>
          <div class="form-group">
            <input type="text"
                   id="new_look_modal_codepen"
                   class="form-control"
                   placeholder="Codepen URL" />
          </div>
          <div class="form-group">
            <textarea id="new_look_modal_description"
                      class="form-control"
                      rows="3"
                      placeholder="Description"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer new_look_modal__footer">
        <button class="btn btn-success" id="new_look_modal_button">Create View</button>
      </div>
    </div>
  </div>
</div>



<script src="/vendor/remarkable.js"></script>

<script>
  (function() {
//    $('#new_look_modal').on('show.bs.modal', function (event) {
//      document.getElementById('new_look_modal_title').focus();
//    });

    document.getElementById('new_look_modal_button').addEventListener('click', function() {
      Mydataspace.entities.request('entities.create', {
        root: DATA.root,
        path: 'views/' + MDSCommon.guid(),
        fields: [
          { name: 'type', value: 'codepen', type: 's' },
          { name: 'id', value: document.getElementById('new_look_modal_title').value, type: 's' },
          { name: 'title', value: document.getElementById('new_look_modal_codepen').value, type: 's' }
        ]
      }).then(function(data) {
        $('#new_look_modal').modal('hide');
        $('#view__looks__previews').append(getLookPreviewHTML(data));
        selectLook(data.path);
      }, function(err) {});
    });

    document.getElementById('delete_look_modal_button').addEventListener('click', function() {
      var lookPath = document.getElementById('view__looks__content').getAttribute('data-look-path');
      Mydataspace.entities.request('entities.delete', {
        root: DATA.root,
        path: lookPath
      }).then(function(data) {
        var previewsElem = document.getElementById('view__looks__previews');
        var previews = previewsElem.childNodes;
        for (var i = 0; i < previews.length; i++) {
          var preview = previews[i];
          if (preview.getAttribute('data-look-path') === lookPath) {
            previewsElem.removeChild(preview);
            break;
          }
        }
        selectLook();
        looksData.splice(i, 1);
        document.getElementById('view__tabs_views_count').innerText = looksData.length;
      }, function(err) {});
    });

    var md = new Remarkable({
      html:         true,        // Enable HTML tags in source
      xhtmlOut:     false,        // Use '/' to close single tags (<br />)
      breaks:       false,        // Convert '\n' in paragraphs into <br>
      langPrefix:   'language-',  // CSS language prefix for fenced blocks
      linkify:      false,        // Autoconvert URL-like text to links

      // Enable some language-neutral replacement + quotes beautification
      typographer:  false,

      // Double + single quotes replacement pairs, when typographer enabled,
      // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
      quotes: '“”‘’',

      // Highlighter function. Should return escaped HTML,
      // or '' if the source string is not changed
      highlight: function (/*str, lang*/) { return ''; }
    });

    var results = new RegExp(".*/([^?#]+)").exec(location.href);
    if (!results) {
      return;
    }

    var DATA = {
      root: results[1] === 'root' ? 'fiftin' : results[1],
      path: '',
      children: true
    };

    var TABS = {
      VIEW_TAB_README_LABEL: 'view__about',
      VIEW_TAB_VIEW_LABEL: 'view__looks',
      VIEW_TAB_COMMENTS_LABEL: 'view__comments'
    };

    var looksData = [];

    function openLookEditModal(isEdit) {
      if (isEdit) {
        var lookData;
        for (var lookIndex in looksData) {
          var look = looksData[lookIndex];
          if (look.path === document.getElementById('view__looks__content').getAttribute('data-look-path')) {
            lookData = look;
            break;
          }
        }
        document.getElementById('new_look_modal_header').innerText = 'Edit View';
        document.getElementById('new_look_modal_button').innerText = 'Save View';
        document.getElementById('new_look_modal_title').value = MDSCommon.findValueByName(lookData.fields, 'title');
        document.getElementById('new_look_modal_codepen').value =  MDSCommon.findValueByName(lookData.fields, 'id');
        document.getElementById('new_look_modal_description').value = MDSCommon.findValueByName(lookData.fields, 'description') || '';
      } else {
        document.getElementById('new_look_modal_header').innerText = 'New View';
        document.getElementById('new_look_modal_button').innerText = 'Create View';
        document.getElementById('new_look_modal_title').value = '';
        document.getElementById('new_look_modal_codepen').value = '';
        document.getElementById('new_look_modal_description').value = '';
      }
      $('#new_look_modal').modal('show');
    }

    function setLook(lookData) {
//      document.getElementById('view__looks__likes_count').innerText = MDSCommon.findValueByName(viewData.children, 'likes');
      document.getElementById('view__looks__date').innerText = MDSCommon.humanizeDate(lookData.createdAt);
      document.getElementById('view__looks__title').innerText = MDSCommon.findValueByName(lookData.fields, 'title');
      document.getElementById('view__looks__content').setAttribute('data-look-path', lookData.path);
      switch (lookData.fields.type) {
        case 'codepen':
          var codepen = MDSCommon.findValueByName(lookData.fields, 'id');
          document.getElementById('view__looks__content').innerHTML =
            '<p data-height="560" data-theme-id="0" data-slug-hash="' + codepen + '" data-default-tab="result" data-user="mydataspace" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/mydataspace/pen/' + codepen + '/">' + codepen + '</a> by My Data Space (<a href="http://codepen.io/mydataspace">@mydataspace</a>) on <a href="http://codepen.io">CodePen</a>.</p>' +
            '';
          var codepenScript = document.createElement('script');
          codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
          document.getElementById('view__looks__content').appendChild(codepenScript);
          break;
        default:
          throw new Error('Unknown view type: ' + lookData.type);
      }
    }

    function selectLook(lookPath) {
      var previews = $('#view__looks__previews');
      previews.find('.look_preview--active').removeClass('look_preview--active');
      for (var lookIndex in looksData) {
        var look = looksData[lookIndex];
        if (lookPath == null || look.path === lookPath) {
          setLook(look);
          var preview = previews.find('.look_preview')[lookIndex];
          preview.classList.add('look_preview--active');
          break;
        }
      }
    }

    function getLookPreviewHTML(lookData, isActive) {
      return '<div class="look_preview' + (isActive ? ' look_preview--active' : '') + '" data-look-path="'+ lookData.path + '">' +
        '<div class="look_preview__header"><i class="fa fa-codepen"></i><span class="look_preview__title">' + MDSCommon.findValueByName(lookData.fields, 'title') + '</span></div>' +
          '<div class="look_preview__description">' + (MDSCommon.findValueByName(lookData.fields, 'description') || '') + '</div>' +
          '<div class="look_preview__footer">' +
            '<span class="view__comment__date">' + MDSCommon.humanizeDate(lookData.createdAt) + '</span>' +
          '</div>' +
        '</div>';
    }

    function getCommentHTML(commentData) {
      var commentText =  (MDSCommon.findValueByName(commentData.fields, 'text') || '').replace(/(?:\r\n|\r|\n)/g, '<br />');
      return '<div class="view__comment" id="' + commentData.path + '" data-comment-path="' + commentData.path + '">' +
        (commentData.mine ? '<span class="view__comment__author">you</span>' : '') +
        '<span class="view__comment__text">' + commentText + '</span>' +
        '<div class="view__comment__footer">' +
          '<span class="view__comment__date">' + MDSCommon.humanizeDate(commentData.createdAt) + ' ago</span>' +
        '</div>' +
        (commentData.mine ? '<div class="view__comment__delete"><i class="fa fa-remove fa-2x"></i></div>' : '') +
      '</div>';
    }

    function postComment() {
      if (!Mydataspace.isLoggedIn()) {
        $('#signin_modal').modal('show');
        return;
      }

      var $newComment = $('#view__new_comment');
      var $textarea = $newComment.find('.new_comment__textarea');
      var $button = $newComment.find('.new_comment__button');

      if ($textarea.val().trim() === '') {
        $textarea.addClass('new_comment__textarea--error');
        $textarea.focus();
        return;
      }

      $button.prop('disabled', true);
      $textarea.prop('disabled', true);

      Mydataspace.request('entities.create', {
        root: DATA.root,
        path: 'comments/' + MDSCommon.guid(),
        fields: [
          {
            name: 'text',
            value: $textarea.val().trim(),
            type: 's'
          }
        ]
      }, function() {
        $textarea.val('');
        $button.prop('disabled', false);
        $textarea.prop('disabled', false);
        $textarea.focus();
        updateCommentFormTextareaHeight();
      }, function(err) {
        $button.prop('disabled', false);
        $textarea.prop('disabled', false);
        console.log(err);
      });
    }

    function updateCommentFormTextareaHeight() {
      var textarea = document.getElementById('view__comments__new_comment_textarea');
      setTimeout(function(){
        textarea.style.cssText = 'height: auto; padding: 0';
        textarea.style.cssText = 'height: ' + textarea.scrollHeight + 'px';
      }, 0);
    }

    function initNewCommentForm() {
      var $newComment = $('#view__new_comment');
      var $textarea = $newComment.find('.new_comment__textarea');
      $textarea.on('focus', function() {
        $(this).parent().parent().find('.new_comment__button').show();
        $(this).addClass('new_comment__textarea--extended');
        if ($textarea.hasClass('new_comment__textarea--error')) {
          setTimeout(function() {
            $textarea.removeClass('new_comment__textarea--error')
          }, 200);
        }
      });
      $textarea.on('keydown', function(event) {
        if (event.ctrlKey && event.keyCode === 13) {
          postComment();
        }
        updateCommentFormTextareaHeight();
      });
      $newComment.find('.new_comment__button').on('click', function() {
        postComment();
      });
    }

    function initCounters() {
      var elem = document.getElementById('view__counters_likes');
      elem.addEventListener('click', function() {
        if (!Mydataspace.isLoggedIn()) {
          $('#signin_modal').modal('show');
          return;
        }

        if (document.getElementById('view__counters_likes_icon').className === 'fa fa-cog fa-spin') {
          return;
        }
        
        document.getElementById('view__counters_likes_icon').className = 'fa fa-cog fa-spin';

        if (MDSCommon.isPresent(elem.getAttribute('data-like-path'))) {
          Mydataspace.entities.request('entities.delete', {
            root: DATA.root,
            path: elem.getAttribute('data-like-path')
          }).then(function() {
            document.getElementById('view__counters_likes_icon').className = 'fa fa-heart';
          }, function(err) {
            document.getElementById('view__counters_likes_icon').className = 'fa fa-heart';
            console.log(err);
          });
        } else {
          Mydataspace.entities.request('entities.create', {
            root: DATA.root,
            path: 'likes/' + MDSCommon.guid()
          }).then(function() {
            document.getElementById('view__counters_likes_icon').className = 'fa fa-heart';
          }, function(err) {
            document.getElementById('view__counters_likes_icon').className = 'fa fa-heart';
            console.log(err);
          });
        }
      });
    }

    function updateLooks(newIndex) {
      if (looksData.length === 0) {
        document.getElementById('view__looks__empty').style.display = 'block';
//        document.getElementById('view__looks__pills').style.display = 'none';
        document.getElementById('view__looks__content_wrap').style.display = 'none';
        return;
      } else {
        document.getElementById('view__looks__empty').style.display = 'none';
//        document.getElementById('view__looks__pills').style.display = 'block';
        document.getElementById('view__looks__content_wrap').style.display = 'block';
      }

      var content = document.getElementById('view__looks__content');
      var index = content.getAttribute('data-view-index');
      if (index == null || newIndex != null) {
        index = newIndex || 0;
        content.setAttribute('data-view-index', index);
      } else {
        index = parseInt(index);
      }
      var lookData = looksData[index];
      if (lookData == null) {
        throw new Error('Illegal view index: ' + index + '. Must be less ' + looksData.length);
      }

      setLook(lookData);

      var previewsHTML = '';
      for (var lookIndex in looksData) {
        previewsHTML += getLookPreviewHTML(looksData[lookIndex], lookIndex.toString() === '0');
      }
      document.getElementById('view__looks__previews').innerHTML = previewsHTML;
    }

    function initTabs() {
      for (var tabID in TABS) {
        (function(tabID) {
          var tab = document.getElementById(tabID);
          tab.addEventListener('click', function(event) {
            event.preventDefault();
            for (var tid in TABS) {
              document.getElementById(tid).classList.remove('view__tab--active');
              document.getElementById(TABS[tid]).style.display = 'none';
            }
            tab.classList.add('view__tab--active');
            document.getElementById(TABS[tabID]).style.display = 'block';

            switch (tabID) {
              case 'VIEW_TAB_VIEW_LABEL':
                document.getElementById('view__data_link').classList.add('hidden');
                document.getElementById('view__new_look').classList.remove('hidden');

                if (document.getElementById('view__tabs_views_count').innerText === '0') {
                  document.getElementById('view__looks__empty').style.display = 'block';
//                  document.getElementById('view__looks__pills').style.display = 'none';
                  document.getElementById('view__looks__content_wrap').style.display = 'none';
                } else {
                  document.getElementById('view__looks__empty').style.display = 'none';
//                  document.getElementById('view__looks__pills').style.display = 'block';
                  document.getElementById('view__looks__content_wrap').style.display = 'block';
                }
                Mydataspace.entities.request('entities.get', { root: DATA.root, children: true, path: 'views' }).then(function(data) {
                  looksData = data.children;
                  updateLooks();
                });
                break;
              case 'VIEW_TAB_COMMENTS_LABEL':
                document.getElementById('view__data_link').classList.add('hidden');
                document.getElementById('view__new_look').classList.add('hidden');
                Mydataspace.entities.request('entities.get', { root: DATA.root, children: true, path: 'comments', limit: 7, orderChildrenBy: '$createdAt DESC' }).then(function(data) {
                  var comments = document.getElementById('view__comments__list');
                  comments.innerHTML = '';
                  var html = '';
                  for (var i in data.children) {
                    html = getCommentHTML(data.children[i]) + html;
                  }
                  comments.innerHTML = html;
                  if(html === '') {
                    document.getElementById('view__comments__empty').style.display = 'block';
                  }
                });
                break;
              case 'VIEW_TAB_README_LABEL':
                document.getElementById('view__data_link').classList.remove('hidden');
                document.getElementById('view__new_look').classList.add('hidden');
                break;
            }

          });
        })(tabID);
      }
    }

    /**
     * Render root page for received data.
     * @param data root's data.
     */
    function setRootView(data) {
      $.ajax({ url: '/fragments/root-view.html', method: 'get' }).then(function(html) {
        var view = document.getElementById('view');
        var websiteURL = data.fields.websiteURL;
        var description = data.fields.description;
        var readme = data.fields.readme;
        var ava = data.fields.avatar;

        view.innerHTML = html;

        if (MDSCommon.isPresent(ava)) {
          ava = Mydataspace.options.apiURL + '/avatars/sm/' + ava + '.png';
        }
        document.getElementById('view__overview_image').src = ava || '/images/icons/root.svg';
        document.getElementById('view__title').innerText =
          data.fields.name || MDSCommon.getPathName(data.root);

        var tags = (data.fields.tags || '').split(' ').filter(function(tag) {
          return tag != null && tag !== '';
        }).map(function(tag) {
          return '<a class="view__tag" href="/?q=%23' + tag + '" onclick="openSearch(\'' + tag + '\'); return false;">' + tag + '</a>';
        }).join(' ');
        document.getElementById('view__tags').innerHTML = tags || '';

        document.getElementById('view__data_link').href = '/#' + data.root;
        document.getElementById('view__data_link').classList.remove('hidden');

        if (tags && websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--large');
          document.getElementById('view__overview_image').classList.add('view__overview_image--large');
        } else if (tags || websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--medium');
          document.getElementById('view__overview_image').classList.add('view__overview_image--medium');
        }

        if (MDSCommon.isBlank(websiteURL)) {
          document.getElementById('view__websiteURL').style.display = 'none';
        } else {
          document.getElementById('view__websiteURL').style.display = 'inline';
          document.getElementById('view__websiteURL').innerText = websiteURL;
          document.getElementById('view__websiteURL').href = websiteURL;
        }

        if (MDSCommon.isBlank(description)) {
          if (MDSCommon.isBlank(websiteURL)) {
            document.getElementById('view__description').innerHTML = '<i>No description or README provided.</i>';
          }
        } else {
          document.getElementById('view__description').innerText = description;
        }

        if (MDSCommon.isBlank(readme)) {
          document.getElementById('view__readme').style.display = 'none';
        } else {
          document.getElementById('view__readme').style.display = 'block';
        }
        document.getElementById('view__readme').innerHTML = md.render(readme);

        document.getElementById('view__tabs').classList.remove('hidden');

        for (var i in data.children) {
          var child = data.children[i];
          switch (child.path) {
            case 'likes':
              document.getElementById('view__counters_likes_count').innerText = child.numberOfChildren;
              break;
            case 'comments':
              document.getElementById('view__counters_comments_count').innerText = child.numberOfChildren;
              document.getElementById('view__tabs_comments_count').innerText = child.numberOfChildren;
              break;
            case 'views':
              document.getElementById('view__tabs_views_count').innerText = child.numberOfChildren;
              break;
          }
        }

//        document.getElementById('view__date').innerText = MDSCommon.humanizeDate(data.createdAt);

        initCounters();

        initTabs();

        initNewCommentForm();

        if (Mydataspace.isLoggedIn()) {
          requestMyLike();
        }

        Mydataspace.on('login', function() {
          requestMyLike();
        });

        $('#view__comments__list').on('click', '.view__comment__delete', function() {
          var commentPath = this.parentNode.getAttribute('data-comment-path');
          $(this).find('i').removeClass('fa-remove');
          $(this).find('i').addClass('fa-cog');
          $(this).find('i').addClass('fa-spin');

          Mydataspace.request('entities.delete', {
            root: DATA.root,
            path: commentPath
          }, function() {
            $(this).find('i').addClass('fa-remove');
            $(this).find('i').removeClass('fa-cog');
            $(this).find('i').removeClass('fa-spin');
          }, function(err) {
            $(this).find('i').addClass('fa-remove');
            $(this).find('i').removeClass('fa-cog');
            $(this).find('i').removeClass('fa-spin');
            console.log(err);
          });
        });

        $('#view__looks__previews').on('click', '.look_preview', function() {
          selectLook($(this).data('look-path'));
        });

        document.getElementById('view__looks__edit').addEventListener('click', function() {
          openLookEditModal(true);
        });

        document.getElementById('view__new_look').addEventListener('click', function() {
          if (!Mydataspace.isLoggedIn()) {
            $('#signin_modal').modal('show');
            return;
          }
          openLookEditModal(false);
        });

      });
    }

    // Load data for root and render it on the page
    Mydataspace.entities.request('entities.get', DATA).then(function(result) {
      setRootView(result);
    });


    //
    // Likes & comments
    //

    Mydataspace.emit('entities.subscribe', {
      root: DATA.root,
      path: 'comments/*'
    });

    Mydataspace.emit('entities.subscribe', {
      root: DATA.root,
      path: 'likes/*'
    });

    Mydataspace.on('entities.create.res', function(data) {
      if (/^likes\//.test(data.path)) {
        document.getElementById('view__counters_likes_count').innerText =
          parseInt(document.getElementById('view__counters_likes_count').innerText) + 1;
        if (data.mine) {
          setMyLike(data);
        }
      } else if (/^comments\//.test(data.path)) {
        document.getElementById('view__tabs_comments_count').innerText =
          parseInt(document.getElementById('view__tabs_comments_count').innerText) + 1;
        document.getElementById('view__counters_comments_count').innerText =
          parseInt(document.getElementById('view__counters_comments_count').innerText) + 1;

        // if comment is not exists already
        if (document.getElementById(data.path) == null) {
          if (document.getElementById('view__comments').style.display === 'block') {
            var commentHTML = getCommentHTML(data);
            $('#view__comments__list').append(commentHTML);
            document.getElementById('view__comments__empty').style.display = 'none';
          }
        }
      }
    });

    Mydataspace.on('entities.delete.res', function(data) {
      if (/^likes\//.test(data.path)) {
        document.getElementById('view__counters_likes_count').innerText =
          parseInt(document.getElementById('view__counters_likes_count').innerText) - 1;
        resetMyLike(data);
      } else if (/^comments\//.test(data.path)) {
        document.getElementById('view__tabs_comments_count').innerText =
          parseInt(document.getElementById('view__tabs_comments_count').innerText) - 1;
        document.getElementById('view__counters_comments_count').innerText =
          parseInt(document.getElementById('view__counters_comments_count').innerText) - 1;

        var comment = document.getElementById(data.path);
        if (comment != null) {
          comment.parentNode.removeChild(comment);
          if (document.getElementById('view__comments__list').children.length === 0) {
            document.getElementById('view__comments__empty').style.display = 'block';
          }
        }
      }
    });

    function setMyLike(data) {
      document.getElementById('view__counters_likes').setAttribute('data-like-path', data.path);
      document.getElementById('view__counters_likes').classList.add('root_counter--active');
    }

    function resetMyLike(data) {
      var path = document.getElementById('view__counters_likes').getAttribute('data-like-path');
      if (MDSCommon.isPresent(path) && (MDSCommon.isBlank(data) || data.path === path)) {
        document.getElementById('view__counters_likes').removeAttribute('data-like-path');
        document.getElementById('view__counters_likes').classList.remove('root_counter--active');
      }
    }

    function requestMyLike() {
      Mydataspace.entities.request('entities.getMyChildren', { root: DATA.root, path: 'likes' }).then(function(result) {
        var children = result.children;
        if (children.length > 0) {
          setMyLike(children[0]);
        } else {
          resetMyLike();
        }
      });
    }
  })();
</script>