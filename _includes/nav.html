{% if page.language == site.default_language %}
{% assign baseurl = "" %}
{% assign baseurl_with_trailing_slash = baseurl | append:"/" %}
{% else %}
{% assign baseurl = page.language | prepend:"/" %}
{% assign baseurl_with_trailing_slash = baseurl | append:"/" %}
{% endif %}
<nav class="navbar navbar-inverse navbar-custom">
    <div class="container">
        <div class="navbar-header page-scroll">
            <a class="navbar-brand header__logo" href="{{ baseurl }}/">
              <img class="header__logo_img" src="/images/transparent_logo_128.png" />
              <img class="header__logo_text" src="/images/logo_text.svg" />
            </a>
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span> <i class="fa fa-2x fa-bars"></i>
            </button>
        </div>

        {% include search.html id="header__search" admin=false resultContainer="search" %}

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li class="hidden">
                    <a href="#page-top"></a>
                </li>
                <li class="hidden-sm header__give_feedback_wrap">
                    <a class="header__menu_item"
                       href="javascript: void(0);"
                       onclick="showFeedbackModal(true); return false;">
                        <div class="header__give_feedback"><i class="fa fa-thumbs-up"></i> <span class="hidden-md" style="padding-left: 5px;">{{ site.data[page.language].menu.give_feedback_button }}</span></div>
                    </a>
                </li>
                <li class="hidden-sm">
                    <a class="header__menu_item" href="{{ baseurl }}/features">{{ site.data[page.language].menu.features }}</a>
                </li>
                <li class="hidden-sm">
                    <a class="header__menu_item" href="{{ baseurl }}/demos">{{ site.data[page.language].menu.demos }}</a>
                </li>
                <li class="hidden-sm">
                    <a class="header__menu_item" href="{{ baseurl }}/docs">{{ site.data[page.language].menu.docs }}</a>
                </li>
                <li>
                {% if page.url != "/404.html" %}
                  <ul class="header__languages">
                  <li class="header__language">
                    {% if page.language == site.default_language %}
                      {% assign url = page.url %}
                    {% else %}
                      {% assign page_lang = page.language | prepend:'/' | append:'/' %}
                      {% assign url = page.url | replace_first:page_lang,"/" %}
                    {% endif %}
                    {% if site.default_language == page.language %}
                    <a id="header_language_button_en" class="header__language_button header__language_button--active" href="{{ url }}">{{ site.default_language | upcase }}</a>
                    {% else %}
                    <a id="header_language_button_en" class="header__language_button" href="{{ url }}">{{ site.default_language | upcase }}</a>
                    {% endif %}
                  </li>
                  {% for lang in site.languages %}
                    <li class="header__language">
                      {% assign page_lang = page.language | prepend:'/' | append:'/' %}
                      {% assign curr_lang = lang | prepend:'/' | append:'/' %}

                      {% if lang == page.language %}
                        {% assign url = page.url %}
                      {% elsif page.language == site.default_language %}
                        {% assign url = page.url | prepend:lang | prepend:'/' %}
                      {% else %}
                        {% assign url = page.url | replace_first:page_lang,curr_lang %}
                      {% endif %}

                      {% if lang == page.language %}
                        <a id="header_language_button_{{lang}}" class="header__language_button header__language_button--active" href="{{ url }}">
                          {{ lang | upcase }}
                        </a>
                      {% else %}
                        <a id="header_language_button_{{lang}}" class="header__language_button" href="{{ url }}">
                          {{ lang | upcase }}
                        </a>
                      {% endif %}
                    </li>
                  {% endfor %}
                  </ul>
                {% endif %}
                </li>
                {% if page.url != baseurl_with_trailing_slash %}
                <li id="profile_button_menu_item">
                  <script>
                    if (isValidJWT(localStorage.getItem('authToken'))) {
                      document.getElementById('profile_button_menu_item').style.display = 'block';
                    }
                  </script>

                  <div class="btn-group">
                    <button type="button"
                            id="profile_button"
                            class="dropdown-toggle profile_button"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false">
                    </button>
                    <button class="profile_button_logout" onclick="Mydataspace.logout();">{{ site.data[page.language].menu.logout }}</button>

                    <ul class="dropdown-menu profile_button__dropdown">
                      <li>
                        <a class="profile_button__dropdown_profile_link"
                           id="profile_button__dropdown_profile_link">
                          <div class="profile_button__dropdown_profile" id="profile_button__dropdown_profile">
                            <div id="profile_button__dropdown_name" class="profile_button__dropdown_name profile_button__dropdown_name--no-login">Anonymous</div>
                            <!--<div id="profile_button__dropdown_login" class="profile_button__dropdown_login">@fiftin</div>-->
                          </div>
                        </a>
                      </li>
                      <li role="separator" class="divider"></li>
                      <li><a href="/"><i class="fa fa-database"></i> <span class="profile_button__dropdown_item">{{ site.data[page.language].menu.myData }}</span></a></li>
                      <li role="separator" class="divider"></li>
                      <li><a href="#" onclick="Mydataspace.logout();"><i class="fa fa-sign-out"></i> <span class="profile_button__dropdown_item">{{ site.data[page.language].menu.logout }}</span></a></li>
                    </ul>
                  </div>
                </li>
                <li id="login_button_menu_item">
                  <script>
                    if (isValidJWT(localStorage.getItem('authToken'))) {
                      document.getElementById('login_button_menu_item').style.display = 'none';
                    }
                  </script>
                  <button id="login_button"
                          class="login_button btn btn-default"
                          data-toggle="modal"
                          data-target="#signin_modal">
                  {{ site.data[page.language].menu.login }}
                  </button>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
    <script>
        (function() {
            if (/^(\/\w+)?\/root.html$/.test('{{ url }}')) {
              var m = location.pathname.match(/^(\/\w+)?\/([\w\d_\-]+)$/);
              if (m) {
                document.getElementById('header_language_button_ru').href = '/ru/' + m[2];
                document.getElementById('header_language_button_en').href = '/' + m[2];
              }
            }
        })();
    </script>
</nav>

<div id="search" class="search">
</div>

<div id="give_feedback_modal"
     class="modal"
     role="dialog"
     aria-labelledby="Give Feedback">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header look_modal__header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <div class="modal-title">{{ site.data[page.language].menu.give_feedback }}</div>
            </div>
            <div class="modal-body look_modal__body">
                <div>
                    <textarea id="give_feedback_modal__text" rows="5" class="form-control" placeholder="{{ site.data[page.language].menu.give_feedback_placeholder }}"></textarea>
                </div>
                <div id="give_feedback_modal__error" class="give_feedback_modal__error"></div>
            </div>
            <div class="modal-footer look_modal__footer">
                <button class="btn btn-primary" id="give_feedback_modal__send">{{ site.data[page.language].menu.send_feedback }}</button>
            </div>
        </div>
    </div>
</div>

<div id="give_feedback_sent_modal"
     class="modal"
     role="dialog"
     aria-labelledby="Feedback Sent">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header look_modal__header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <div class="modal-title">{{ site.data[page.language].menu.feedback_sent_title }}</div>
            </div>
            <div class="modal-body look_modal__body">
                {{ site.data[page.language].menu.feedback_sent_message }}
            </div>
            <div class="modal-footer look_modal__footer">
                <button class="btn btn-default" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
  function showFeedbackModal(needClear) {
    if (needClear) {
      $('#give_feedback_modal__text').val('');
      $('#give_feedback_modal__send').prop('disabled', false);
      $('#give_feedback_modal__text').prop('disabled', false);
      $('#give_feedback_modal__text').removeClass('new_comment__textarea--error');
      $('#give_feedback_modal__error').text('');
    }
    $('#give_feedback_modal').modal('show');
  }

  $(function() {
    var $textarea = $('#give_feedback_modal__text');
    var $button = $('#give_feedback_modal__send');
    var $error = $('#give_feedback_modal__error');


    function giveFeedback() {
      $textarea.removeClass('new_comment__textarea--error');

      if ($textarea.val().trim() === '') {
        $textarea.addClass('new_comment__textarea--error');
        $error.text('{{ site.data[page.language].menu.feedback_cant_be_blank }}');
        $textarea.focus();
        return;
      }

      $button.prop('disabled', true);
      $textarea.prop('disabled', true);

      Mydataspace.request('entities.create', {
        root: 'feedback',
        path: 'data/' + MDSCommon.guid(),
        fields: [
          {
            name: 'text',
            value: $textarea.val().trim(),
            type: 's'
          },
          {
            name: 'rate',
            value: '0',
            type: 'i'
          }
        ]
      }, function () {
        $('#give_feedback_modal').modal('hide');
        $('#give_feedback_sent_modal').modal('show');
      }, function (err) {
        $button.prop('disabled', false);
        $textarea.prop('disabled', false);
        console.log(err);
        $error.text(err.message);
        $textarea.focus();
      });
    }


    $('#give_feedback_modal').on('shown.bs.modal', function () {
      $textarea.focus();
    });

    $button.click(function () {

      if (!Mydataspace.isLoggedIn()) {
        Mydataspace.on('login', function () {
          setTimeout(function() {
            showFeedbackModal();
            giveFeedback();
          }, 300);
        });
        $('#give_feedback_modal').modal('hide');
        setTimeout(function() {
          $('#signin_modal').modal('show');
        }, 300);
        return;
      }
      giveFeedback();
    });
  });
</script>