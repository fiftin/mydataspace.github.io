{% if jekyll.environment == "local" %}
  {% assign client_id = "my-data.space" %}
  {% assign api_url = site.local_api_url %}
  {% assign cdn_url = site.local_api_url %}
{% else %}
  {% assign client_id = site.client_id %}
  {% assign api_url = site.api_url %}
  {% assign cdn_url = site.cdn_url %}
{% endif %}

<script src="/vendor/remarkable.js"></script>

<script>

  (function() {
    var language = '{{ include.language }}';

    var results = new RegExp("[^?#]*/([^?#\/]+)").exec(location.href);
    if (!results) {
      return;
    }
    var search = location.search;
    if (search.length > 0) {
      search = search.substr(1);
    }

    var searchParts = search.split('&');
    var searchParams = {};
    for (var i = 0; i < searchParts.length; i++) {
      var part = searchParts[i];
      var keyValue = part.split('=');
      searchParams[keyValue[0]] = keyValue[1];
    }

    var DATA = {
      root: results[1] === 'root' ? '11111' : results[1],
      path: '',
      version: searchParams.v
    };
    
    if (DATA.root === 'search') {
      openSearch_header__search('', true);
      return;
    }

    var TABS = {
      VIEW_TAB_README_LABEL: 'root__about',
      VIEW_TAB_VIEW_LABEL: 'root__looks',
      VIEW_TAB_COMMENTS_LABEL: 'root__comments',
      VIEW_TAB_EXPLORE_LABEL: ''
    };


    /**
     * Add JSON-LD for Google Search Engine
     * @param {Object} data - Data receviced for current root from MyDataSpace backend.
     */
    function addJsonLD(data) {
      var script = document.createElement('script');
      script.type = 'application/ld+json';
      script.text = JSON.stringify({
        "@context": "http://schema.org",
        "@id": "https://myda.space/" + data.root,
        "@type": "Dataset",
        "name":  MDSCommon.findValueByName(data.fields, 'name'),
        "description": MDSCommon.findValueByName(data.fields, 'description'),
        "keywords": MDSCommon.findValueByName(data.fields, 'tags'),
        //"readme": MDSCommon.findValueByName(data.fields, 'readme')
      });
      document.querySelector('head').appendChild(script);
    }

    function loadEntityData(method, requestData, success, fail) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState === XMLHttpRequest.DONE ) {
          if (xmlhttp.status === 200) {
            var data = JSON.parse(xmlhttp.responseText);
            success(data);
          } else {
            fail();
          }
        }
      };
      var query = '';
      for (var k in requestData) {
        if (query !== '') {
          query += '&';
        }
        if (requestData[k] != null) {
          query += k + '=' + requestData[k];
        }
      }
      xmlhttp.open('GET', '{{ api_url }}/v1/entities/' + method + '?' + query, true);
      xmlhttp.send();
    }

    loadEntityData('get', MDSCommon.extend(DATA, { children: true }), function(result) {
      addJsonLD(result);
      setRootView(result);
    }, function() {});

    //
    // Save view button
    $('#look_modal__button').click(function() {
      if (!validateLookForm()) {
        return;
      }

      var lookPath = $('#look_modal__button').data('look-path');

      $('.modal-backdrop').css('opacity', 1);
      $('#look_modal__locker').removeClass('hidden');

      switch ($('#look_modal').data('look-type')) {
        case 'codepen':
          Mydataspace.request(lookPath ? 'entities.change' : 'entities.create', MDSCommon.extend(DATA, {
            path: lookPath || 'views/' + MDSCommon.guid(),
            fields: [
              { name: 'type', value: 'codepen', type: 's' },
              { name: 'title', value: $('#look_modal__title').val(), type: 's' },
              {
                name: 'id',
                value: getCodepenIDByURL($('#look_modal__codepen').val()),
                type: 's'
              },
              { name: 'description', value: $('#look_modal__description').val(), type: 's' }
            ]
          })).then(function(data) {
            $('#look_modal').modal('hide');
            $('.modal-backdrop').css('opacity', null);
            if (!lookPath) {
              setTimeout(function() { selectLook(data.path); }, 500);
            }
          }, function(err) {
            $('.modal-backdrop').css('opacity', null);
            UI.error(err);
          });
          break;
        case 'table':
          Mydataspace.request(lookPath ? 'entities.change' : 'entities.create', MDSCommon.extend(DATA, {
            path: lookPath || 'views/' + MDSCommon.guid(),
            fields: [
              { name: 'type', value: 'table', type: 's' },
              { name: 'title', value: $('#look_modal__title').val(), type: 's' },
              { name: 'description', value: $('#look_modal__description').val(), type: 's' },
              { name: 'path', value: $('#look_modal__table_path').val(), type: 's' }
            ]
          })).then(function(data) {
            return Promise.all([data, Mydataspace.request('entities.delete', MDSCommon.extend(DATA, {
              path: data.path + '/columns'
            })).catch(function() {})]);
          }).then(function(res) {
            var data = res[0];
            return Promise.all([data, Mydataspace.request('entities.create', MDSCommon.extend(DATA, {
              path: data.path + '/columns'
            }))]);
          }).then(function(res) {
            var data = res[0];
            var columns = [];
            var i = 0;
            $$('look_modal__table').data.each(function(obj) {
              columns.push(MDSCommon.extend(DATA, {
                path: data.path + '/columns/' + MDSCommon.guid(),
                fields: [
                  { name: 'index', value: i, type: 'i' },
                  { name: 'title', value: obj.title, type: 's' },
                  { name: 'value', value: obj.value, type: 's' },
                  { name: 'width', value: obj.width, type: 'i' }
                ]
              }));
              i++;
            });
            return Promise.all([data, Mydataspace.request('entities.create', columns)]);
          }).then(function(res) {
            var data = res[0];
            setTimeout(function() {
              $('.modal-backdrop').css('opacity', null);
              selectLook(data.path);
              $('#look_modal').modal('hide');
            }, 500);
          }, function(err) {
            $('.modal-backdrop').css('opacity', null);
            UI.error(err);
          });
          break;
      }
    });


    //
    // Delete view button
    document.getElementById('delete_look_modal_button').addEventListener('click', function() {
      var lookPath = $('#root__looks__content').data('look-path');
      Mydataspace.request('entities.delete', MDSCommon.extend(DATA, {
        path: lookPath
      })).then(function(data) { }, function(err) {});
    });

    Mydataspace.on('entities.change.res', function(data) {
      if (/^views\/[^\/]*$/.test(data.path)) {
        var preview = getLookPreviewNode(data.path);
        if (!preview) {
          throw new Error('Changed look is not exists');
        }

        $(preview).replaceWith(getUnwrappedLookPreviewHTML(data, true));
        preview = getLookPreviewNode(data.path);
        $(preview).data('look-data', data);

        switch (MDSCommon.findValueByName(data.fields, 'type')) {
          case 'codepen':
            var codepenScript = document.createElement('script');
            codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
            preview.appendChild(codepenScript);
            break;
          case 'table':
            ;
            break;
        }


        if (currentLook.path === data.path) {
          setLook(data);
        }
      }
    });

    var md = new Remarkable({
      html:         true,        // Enable HTML tags in source
      xhtmlOut:     false,        // Use '/' to close single tags (<br />)
      breaks:       false,        // Convert '\n' in paragraphs into <br>
      langPrefix:   'language-',  // CSS language prefix for fenced blocks
      linkify:      false,        // Autoconvert URL-like text to links

      // Enable some language-neutral replacement + quotes beautification
      typographer:  false,

      // Double + single quotes replacement pairs, when typographer enabled,
      // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
      quotes: '“”‘’',

      // Highlighter function. Should return escaped HTML,
      // or '' if the source string is not changed
      highlight: function (/*str, lang*/) { return ''; }
    });

    var currentLook;

    function validateLookForm() {
      document.getElementById('look_modal__title_err').innerText = '';
      document.getElementById('look_modal__codepen_err').innerText = '';

      var title = document.getElementById('look_modal__title').value;
      var codepen = document.getElementById('look_modal__codepen').value;

      if (MDSCommon.isBlank(title)) {
        document.getElementById('look_modal__title_err').innerText = tr$('title_cant_be_blank');
        return false;
      }

      if (title.length > 250) {
        document.getElementById('look_modal__title_err').innerText = tr$('too_long_title');
        return false;
      }

      switch ($('#look_modal').data('look-type')) {
        case 'codepen':
          if (MDSCommon.isBlank(codepen)) {
            document.getElementById('look_modal__codepen_err').innerText = tr$('codepen_url_cant_be_blank');
            return false;
          }
          var codepenID = getCodepenIDByURL(codepen);
          if (!codepenID) {
            document.getElementById('look_modal__codepen_err').innerText = tr$('invalid_codepen_pen_url');
            return false;
          }
          break;
        case 'table':
          break;
      }
      return true;
    }

    function getCodepenIDByURL(url) {
      var regex = /^https?:\/\/codepen.io\/(\w+)\/pen\/(\w+)/;
      var m = regex.exec(url);
      if (!m) {
        return null;
      }
      return m[1] + '/' + m[2];
    }

    function getCodepenURL(id) {
      var parts = id.split('/');
      return 'https://codepen.io/' + parts[0] + '/pen/' + parts[1];
    }

    /**
     *
     */
    function getLookPreviewNode(path) {
      var ret;
      $('#root__looks__previews').find('.look_preview').each(function() {
        if ($(this).data('look-path') === path) {
          ret = this;
          return false;
        }
      });
      return ret;
    }

    /**
     *
     */
    function openLookEditModal(isEdit) {
      $('#look_modal').modal('show');
      if (isEdit) {
        document.getElementById('look_modal__header').innerText = tr$('edit_view');
        document.getElementById('look_modal__button').setAttribute('data-look-path', currentLook.path);
        document.getElementById('look_modal__button').innerText = tr$('save_view');
        document.getElementById('look_modal__title').value = MDSCommon.findValueByName(currentLook.fields, 'title');
        document.getElementById('look_modal__description').value = MDSCommon.findValueByName(currentLook.fields, 'description') || '';
        var type = MDSCommon.findValueByName(currentLook.fields, 'type');
        $('#look_modal__' + type + '_tab').addClass('active');
        $('#look_modal__' + type + '_wrap').removeClass('hidden');
        $('#look_modal').data('look-type', type);
        switch (type) {
          case 'codepen':
            document.getElementById('look_modal__codepen').value = getCodepenURL(MDSCommon.findValueByName(currentLook.fields, 'id'));
            break;
          case 'table':
            $('#look_modal__table_path').val(MDSCommon.findValueByName(currentLook.fields, 'path'));
            Mydataspace.request('entities.get', MDSCommon.extend(DATA, { path: currentLook.path + '/columns', children: true })).then(function(columnsData) {
              var formattedData = columnsData.children.map(function(column) {
                return {
                  value: MDSCommon.findValueByName(column.fields, 'value'),
                  title: MDSCommon.findValueByName(column.fields, 'title'),
                  width: parseInt(MDSCommon.findValueByName(column.fields, 'width')) || 200
                }
              });
              $$('look_modal__table').parse(formattedData);
            });
            break;
        }
      } else {
        $('#look_modal').data('look-type', 'codepen');
        document.getElementById('look_modal__header').innerText = tr$('new_view');
        document.getElementById('look_modal__button').removeAttribute('data-look-path');
        document.getElementById('look_modal__button').innerText = tr$('create_view');
        $('#look_modal__codepen_tab').addClass('active');
        $('#look_modal__codepen_wrap').removeClass('hidden');
      }
    }

    function setLook(lookMetaData) {
      $('#root__looks__actions').find('.look__action--only-owner').css('display', lookMetaData.mine ? 'block' : 'none');
      $('#root__looks__title_icon').attr('class', '');
      $('#root__looks__title').text(MDSCommon.findValueByName(lookMetaData.fields, 'title'));
      $('#root__looks__content').data('look-path', lookMetaData.path);
      switch (MDSCommon.findValueByName(lookMetaData.fields, 'type')) {
        case 'table':
          if ($$('root__looks__content_wrap')) {
            $$('root__looks__content_wrap').destructor();
          }
          $('#root__looks__content').html('');
          Mydataspace.request('entities.get', MDSCommon.extend(DATA, { path: lookMetaData.path + '/columns', children: true })).then(function(columnsMetaData) {
            var columns = columnsMetaData.children.map(function(column) {
              return {
                id: MDSCommon.getPathName(column.path),
                header: [MDSCommon.findValueByName(column.fields, 'title'), {
                  content: 'serverFilter',
                  css: 'root__looks__table_header'
                }],
                width: parseInt(MDSCommon.findValueByName(column.fields, 'width')) || 200,
                sort: 'server'
              };
            });
            columns.push({
              header: '',
              fillspace: true
            });
            webix.ui({
              container: 'root__looks__content',
              id: 'root__looks__content_wrap',
              rows: [
                { padding: 3,
                  css: 'root__about__look_search',
                  cols: [
                    { view: 'search',
                      icon: 'search',
                      id: 'root__looks__content_search',
                      placeholder: 'Search...',
                      on: {
                        onTimedKeyPress: function(code, e) {
                          $$('root__looks__content').define('search', this.getValue());
                          $$('root__looks__content').load('look->');
                        }
                      }
                    }
                  ]
                },
                { view: 'datatable',
                  id: 'root__looks__content',
                  css: 'root__about__look_webix',
                  columns: columns,
                  select: 'row',
                  resizeColumn: true,
                  headerRowHeight: 40,
                  navigation: true,
                  datafetch: 40,
                  loadahead: 20,
                  height: $(window).innerHeight() - 133,
                  clipboard: 'selection',
                  lookMetaData: lookMetaData,
                  columnsMetaData: columnsMetaData,
                  DATA: DATA,
                  url: 'look->',
                  pager: 'root__looks__content_pager',
                  on: {
                    onColumnResize: function (id, newWidth, oldWidth, user_action) {
                      if (!user_action) {
                        return;
                      }
                      Mydataspace.request('entities.change', MDSCommon.extend(DATA, {
                        path: lookMetaData.path + '/columns/' + id,
                        fields: [
                          {name: 'width', value: newWidth, type: 'i'}
                        ]
                      })).catch(function () {
                      });
                    }
                  }
                },
                { css: 'root__about__look_pager_wrap',
                  cols: [
                    { view: 'pager',
                      id: 'root__looks__content_pager',
                      size: 40,
                      group: 5,
                      height: 40,
                      css: 'root__about__look_pager'
                    }
                  ]
                }
              ]
            });
          });
          break;
      }
      currentLook = lookMetaData;
    }


    function unselectLook() {
      var previews = document.getElementById('root__looks__previews');
      $(previews).find('.look_preview--active').removeClass('look_preview--active');
      $('#root__looks__content_wrap').css('display', 'none');
      $('body').css('overflow', '');
      currentLook = null;
      $('#root__looks__content').data('look-path', null);
    }


    function selectLook(path) {
      if (path == null) {
        throw new Error('Look path cant be null');
      }

      var preview = getLookPreviewNode(path);

      if (!preview) {
        return;
      }

      $('#root__looks__previews').find('.look_preview--active').removeClass('look_preview--active');

      $('#root__looks__content_wrap').css('display', 'block');

      $('body').css('overflow', 'hidden');

      $(preview).addClass('look_preview--active');

      setLook($(preview).data('look-data'));
    }

    function getUnwrappedLookPreviewHTML(data, isActive) {
      switch (MDSCommon.findValueByName(data.fields, 'type')) {
        case 'codepen':
          var codepenParts = MDSCommon.findValueByName(data.fields, 'id').split('/');
          return '<div data-look-path="'+ data.path + '" class="block snippet look_preview' + (isActive ? ' look_preview--active' : '') + '">' +
            '<div class="look_preview__codepen_wrap"><p data-height="402" data-theme-id="0" data-slug-hash="' + codepenParts[1] + '" data-default-tab="result" data-user="'+ codepenParts[0] +'" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/' +  codepenParts[0] + '/pen/' + codepenParts[1] + '/">' + codepenParts[1] + '</a> by My Data Space (<a href="http://codepen.io/mydataspace">@mydataspace</a>) on <a href="http://codepen.io">CodePen</a>.</p></div>' +
            '<div class="look_preview__overview look_preview__overview--codepen">' +
            '<div class="look_preview__header"><i class="fa fa-codepen"></i><span class="look_preview__title">' + MDSCommon.findValueByName(data.fields, 'title') + '</span></div>' +
            '</div>' +
            '<div class="look_preview__codepen_locker">' +
            '<div class="look_preview__header"><i class="fa fa-codepen"></i><span class="look_preview__title">' + MDSCommon.findValueByName(data.fields, 'title') + '</span></div>' +
            '<div class="look_preview__description">' + (MDSCommon.findValueByName(data.fields, 'description') || '') + '</div>' +
            '<div class="look_preview__footer">' +
            '<span class="view__comment__date view__comment__date--small">' + tr$('created') + ' ' + MDSCommon.humanizeDate(data.createdAt) + ' ' + tr$('ago') + '</span>' +
            '</div>' +
            '</div>' +
            '</div>';
        case 'table':
          return '<div data-look-path="'+ data.path + '" class="block snippet look_preview look_preview--table' + (isActive ? ' look_preview--active' : '') + '">' +
            '<div class="look_preview__overview">' +
            '<div class="look_preview__header"><i class="fa fa-table"></i><span class="look_preview__title">' + MDSCommon.findValueByName(data.fields, 'title') + '</span></div>' +
            '<div class="look_preview__description">' + (MDSCommon.findValueByName(data.fields, 'description') || '') + '</div>' +
            '</div>' +
            '<div class="look_preview__footer">' +
            '<span class="view__comment__date view__comment__date--small">' + tr$('created') + ' ' + MDSCommon.humanizeDate(data.createdAt) + ' ' + tr$('ago') + '</span>' +
            '</div>' +
            '<div class="look_preview__codepen_locker">' +
            '<div class="look_preview__header"><i class="fa fa-table"></i><span class="look_preview__title">' + MDSCommon.findValueByName(data.fields, 'title') + '</span></div>' +
            '<div class="look_preview__description">' + (MDSCommon.findValueByName(data.fields, 'description') || '') + '</div>' +
            '</div>' +
            '<div class="look_preview__footer">' +
            '<span class="view__comment__date view__comment__date--small view__comment__date--preview-table">' + tr$('created') + ' ' + MDSCommon.humanizeDate(data.createdAt) + ' ' + tr$('ago') + '</span>' +
            '</div>' +
            '</div>';
          break;
      }
    }

    function getLookPreviewHTML(data, isActive) {
      return '<div class="col-md-4">' + getUnwrappedLookPreviewHTML(data, isActive) + '</div>';
    }

    function getCommentHTML(commentData) {
      var commentText =  (MDSCommon.findValueByName(commentData.fields, 'text') || '').replace(/(?:\r\n|\r|\n)/g, '<br />');
      return '<div class="view__comment" id="' + commentData.path + '" data-comment-path="' + commentData.path + '">' +
        (commentData.mine ? '<span class="view__comment__author">you</span>' : '') +
        '<span class="view__comment__text">' + commentText + '</span>' +
        '<div class="view__comment__footer">' +
        '<span class="view__comment__date">' + MDSCommon.humanizeDate(commentData.createdAt) + ' ago</span>' +
        '</div>' +
        (commentData.mine ? '<div class="view__comment__delete"><i class="fa fa-remove fa-2x"></i></div>' : '') +
        '</div>';
    }

    function postComment() {
      if (!Mydataspace.isLoggedIn()) {
        $('#signin_modal').modal('show');
        return;
      }

      var $newComment = $('#root__new_comment');
      var $textarea = $newComment.find('.new_comment__textarea');
      var $button = $newComment.find('.new_comment__button');

      if ($textarea.val().trim() === '') {
        $textarea.addClass('new_comment__textarea--error');
        $textarea.focus();
        return;
      }

      $button.prop('disabled', true);
      $textarea.prop('disabled', true);

      Mydataspace.request('entities.create', {
        root: DATA.root,
        path: 'comments/' + MDSCommon.guid(),
        fields: [
          {
            name: 'text',
            value: $textarea.val().trim(),
            type: 's'
          }
        ]
      }, function() {
        $textarea.val('');
        $button.prop('disabled', false);
        $textarea.prop('disabled', false);
        $textarea.focus();
        updateCommentFormTextareaHeight();
      }, function(err) {
        $button.prop('disabled', false);
        $textarea.prop('disabled', false);
        console.log(err);
      });
    }

    function updateCommentFormTextareaHeight() {
      var textarea = document.getElementById('root__comments__new_comment_textarea');
      setTimeout(function(){
        textarea.style.cssText = 'height: auto; padding: 0';
        textarea.style.cssText = 'height: ' + textarea.scrollHeight + 'px';
      }, 0);
    }

    function initNewCommentForm() {
      var $newComment = $('#root__new_comment');
      var $textarea = $newComment.find('.new_comment__textarea');
      $textarea.on('focus', function() {
        $(this).parent().parent().find('.new_comment__button').show();
        $(this).addClass('new_comment__textarea--extended');
        if ($textarea.hasClass('new_comment__textarea--error')) {
          setTimeout(function() {
            $textarea.removeClass('new_comment__textarea--error')
          }, 200);
        }
      });
      $textarea.on('keydown', function(event) {
        if (event.ctrlKey && event.keyCode === 13) {
          postComment();
        }
        updateCommentFormTextareaHeight();
      });
      $newComment.find('.new_comment__button').on('click', function() {
        postComment();
      });
    }

    function initCounters() {
      $('#root__counters_comments').click(function() {
        selectTab('VIEW_TAB_COMMENTS_LABEL');
      });

      var likesElem = document.getElementById('root__counters_likes');
      likesElem.addEventListener('click', function() {
        if (!Mydataspace.isLoggedIn()) {
          $('#signin_modal').modal('show');
          return;
        }

        if (document.getElementById('root__counters_likes_icon').className === 'fa like_icon_animation fa-heart') {
          return;
        }

        document.getElementById('root__counters_likes_icon').className = 'fa like_icon_animation fa-heart';

        if (MDSCommon.isPresent(likesElem.getAttribute('data-like-path'))) {
          Mydataspace.entities.request('entities.delete', MDSCommon.extend(DATA, {
            path: likesElem.getAttribute('data-like-path')
          })).then(function() {
            document.getElementById('root__counters_likes_icon').className = 'fa fa-heart';
          }, function(err) {
            document.getElementById('root__counters_likes_icon').className = 'fa fa-heart';
            console.log(err);
          });
        } else {
          Mydataspace.entities.request('entities.create', MDSCommon.extend(DATA, {
            path: 'likes/' + MDSCommon.guid()
          })).then(function() {
            document.getElementById('root__counters_likes_icon').className = 'fa fa-heart';
          }, function(err) {
            document.getElementById('root__counters_likes_icon').className = 'fa fa-heart';
            console.log(err);
          });
        }
      });
    }

    function updateLooks(looksData) {
      if (looksData.length === 0) {
        $('#root__looks__empty').css('display', 'block');
        return;
      }

      $('#root__looks__empty').css('display', 'none');

      var previewsHTML = '';
      $.each(looksData, function(i, val) {
        previewsHTML += getLookPreviewHTML(val);
      });

      $('#root__looks__previews').html(previewsHTML).find('.look_preview').each(function(i) {
        $(this).data('look-data', looksData[i]);
      });

      var codepenScript = document.createElement('script');
      codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
      document.getElementById('root__looks').appendChild(codepenScript);
    }


    function selectTab(tabID) {
      var tab = document.getElementById(tabID);
      var el;
      for (var tid in TABS) {
        document.getElementById(tid).classList.remove('view__tab--active');
        el = document.getElementById(TABS[tid]);
        if (el) {
          el.style.display = 'none';
        }
      }
      tab.classList.add('view__tab--active');

      el = document.getElementById(TABS[tabID]);
      if (el) {
        el.style.display = 'block';
      }

      document.getElementById('webix').style.display = 'none';
      switch (tabID) {
        case 'VIEW_TAB_VIEW_LABEL':
          document.getElementById('root__new_look').classList.remove('hidden');

          if (document.getElementById('root__tabs_views_count').innerText === '0') {
            document.getElementById('root__looks__empty').style.display = 'block';
          } else {
            document.getElementById('root__looks__empty').style.display = 'none';
          }
          Mydataspace.entities.request('entities.get', MDSCommon.extend(DATA, { children: true, path: 'views' })).then(function(data) {
            updateLooks(data.children);
          });
          break;
        case 'VIEW_TAB_COMMENTS_LABEL':
          document.getElementById('root__new_look').classList.add('hidden');
          Mydataspace.entities.request('entities.get', MDSCommon.extend(DATA, { children: true, path: 'comments', limit: 7, orderChildrenBy: '$createdAt DESC' })).then(function(data) {
            var comments = document.getElementById('root__comments__list');
            comments.innerHTML = '';
            var html = '';
            for (var i in data.children) {
              html = getCommentHTML(data.children[i]) + html;
            }
            comments.innerHTML = html;
            if(html === '') {
              document.getElementById('root__comments__empty').style.display = 'block';
            }
          });
          break;
        case 'VIEW_TAB_README_LABEL':
          //document.getElementById('root__data_link').classList.remove('hidden');
          document.getElementById('root__new_look').classList.add('hidden');
          break;
        case 'VIEW_TAB_EXPLORE_LABEL':
          document.getElementById('bootstrap').style.display = 'block';
          document.getElementById('webix').style.display = 'block';
          break;
      }
    }

    function initTabs() {
      for (var tabID in TABS) {
        (function(tabID) {
          var tab = document.getElementById(tabID);
          tab.addEventListener('click', function(event) {
            event.preventDefault();
            selectTab(tabID);
          });
        })(tabID);
      }
    }

    /**
     * Render root page for received data.
     * @param data root's data.
     */
    function setRootView(data) {
      var lang;
      if (MDSCommon.isBlank(language) || language === 'en') {
        lang = '';
      } else {
        lang = '/' + language;
      }
      $.ajax({ url: lang + '/fragments/root-page.html', method: 'get' }).then(function(html) {
        var view = document.getElementById('root');
        var websiteURL = MDSCommon.findValueByName(data.fields, 'websiteURL');
        var description = MDSCommon.findValueByName(data.fields, 'description');
        var readme = MDSCommon.findValueByName(data.fields, 'readme');
        var ava = MDSCommon.findValueByName(data.fields, 'avatar');

        view.innerHTML = html;

        if (MDSCommon.isPresent(ava)) {
          ava = Mydataspace.options.cdnURL + '/avatars/sm/' + ava + '.png';
        }
        document.getElementById('root__overview_image').src = ava || '/images/icons/root.svg';
        document.getElementById('root__title').innerText =
          MDSCommon.findValueByName(data.fields, 'name') || MDSCommon.getPathName(data.root);

        document.getElementById('root__version').innerText = '#' +
          (MDSCommon.findValueByName(data.fields, '$version') || 0);

//        if (data.fields.language) {
//          document.getElementById('root__language').className = 'flag-icon flag-icon-' + data.fields.language;
//        }
//        if (data.fields.country) {
//          document.getElementById('root__country').className = 'flag-icon flag-icon-' + data.fields.country;
//        }

        var tags = (MDSCommon.findValueByName(data.fields, 'tags') || '').split(' ').filter(function(tag) {
          return tag != null && tag !== '';
        }).map(function(tag) {
          return '<a class="view__tag" href="/?q=%23' + tag + '" onclick="openSearch_header__search(\'' + tag + '\'); return false;">' + tag + '</a>';
        }).join(' ');
        if (MDSCommon.isPresent(tags)) {
          document.getElementById('root__tags').innerHTML = tags;
        } else {
          document.getElementById('root__tags').style.display = 'none';
        }


        if (tags && websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--large');
          document.getElementById('root__overview_image').classList.add('view__overview_image--large');
        } else if (tags || websiteURL) {
          document.getElementsByClassName('view__overview_image_wrap')[0].classList.add('view__overview_image_wrap--medium');
          document.getElementById('root__overview_image').classList.add('view__overview_image--medium');
        }

        if (MDSCommon.isBlank(websiteURL)) {
          document.getElementById('root__websiteURL').style.display = 'none';
        } else {
          document.getElementById('root__websiteURL').style.display = 'inline';
          document.getElementById('root__websiteURL').innerText = websiteURL;
          document.getElementById('root__websiteURL').href = websiteURL;
        }

        if (MDSCommon.isBlank(description)) {
          if (MDSCommon.isBlank(websiteURL)) {
            document.getElementById('root__description').innerHTML = '<i>' + 
            STRINGS.no_description_provided +
            '</i>';
          }
        } else {
          document.getElementById('root__description').innerText = description;
        }

        if (MDSCommon.isBlank(readme)) {
          document.getElementById('root__readme').style.display = 'none';
        } else {
          document.getElementById('root__readme').style.display = 'block';
        }
        document.getElementById('root__readme').innerHTML = md.render(readme);

        document.getElementById('root__tabs').classList.remove('hidden');

        
        for (var i in data.children) {
          var child = data.children[i];
          switch (child.path) {
            case 'views':
              document.getElementById('root__tabs_views_count').innerText = child.numberOfChildren;
              break;
          }
        }

        document.getElementById('root__counters_likes_count').innerText = MDSCommon.findValueByName(data.fields, '$likes');
        document.getElementById('root__counters_comments_count').innerText = MDSCommon.findValueByName(data.fields, '$comments');
        document.getElementById('root__tabs_comments_count').innerText = MDSCommon.findValueByName(data.fields, '$comments');

        //data.profile = {
        //  name: 'Denis',
        //  username: 'denis',
        //  about: 'Hello, World!',
        //};
        if (MDSCommon.isBlank(data.profile)) {
          document.getElementById('root__side_panel').style.display = 'none';
          document.getElementById('root__about_content').style.width = '100%';
        } else if (document.getElementById('root__user')) {
          document.getElementById('root__user_name').innerText = data.profile.name;
          if (data.profile.verified) {
            document.getElementById('root__user_verified').style.display = 'block';
            document.getElementById('root__user_name').classList.add('view__user_name--verified');
          }
          document.getElementById('root__user_username').innerText = '@' + data.profile.username;
          if (data.profile.about) {
            document.getElementById('root__user_about').innerText = data.profile.about;
          } else {
            document.getElementById('root__user_about').style.display = 'none';
          }
          var userAvatar = MDSCommon.isPresent(data.profile.avatar) ? 'https://cdn.mydataspace.net/avatars/lg/' + data.profile.avatar + '.png' : 'https://myda.space/images/no_avatar.png';
          var userCover = MDSCommon.isPresent(data.profile.cover) ? 'https://cdn.mydataspace.net/images/md/' + data.profile.avatar + '.png' : 'https://myda.space/images/default_cover_sm.jpg';
          document.getElementById('root__user_avatar').src = userAvatar;
          document.getElementById('root__user_cover').style.backgroundImage = 'url("' + userCover + '")';
        }

//        document.getElementById('root__date').innerText = MDSCommon.humanizeDate(data.createdAt);

        initCounters();

        initTabs();

        initNewCommentForm();

        if (Mydataspace.isLoggedIn()) {
          requestMyLike();
        }

        Mydataspace.on('login', function() {
          requestMyLike();
          if (currentLook) {
            selectLook(currentLook.path);
          }
        });

        $('#root__comments__list').on('click', '.view__comment__delete', function() {
          var commentPath = this.parentNode.getAttribute('data-comment-path');
          $(this).find('i').addClass('fa-spin');

          Mydataspace.request('entities.delete', MDSCommon.extend(DATA, {
            path: commentPath
          }, function() {
            $(this).find('i').removeClass('fa-spin');
          }, function(err) {
            $(this).find('i').removeClass('fa-spin');
            console.log(err);
          }));
        });

        $('#root__looks__previews').on('click', '.look_preview', function() {
          selectLook($(this).data('look-path'));
        });


        document.getElementById('root__looks__close').addEventListener('click', function() {
          unselectLook();
        });

        document.getElementById('root__looks__edit').addEventListener('click', function() {
          openLookEditModal(true);
        });

        document.getElementById('root__new_look').addEventListener('click', function() {
          if (!Mydataspace.isLoggedIn()) {
            $('#signin_modal').modal('show');
            return;
          }
          openLookEditModal(false);
        });

        document.getElementById('root__version').addEventListener('click', function() {
          loadEntityData('getRootVersions', DATA, function(result) {
            var table = document.getElementById('change_root_version_modal__table').tBodies[0];

            for (var i = table.rows.length - 1; i >= 0; i--) {
              table.deleteRow(i);
            }

            for (var i = 0; i < result.versions.length; i++) {
              var row = table.insertRow();
              var version = result.versions[i];
              var number = row.insertCell(0);
              var createdAt = row.insertCell(1);
              var description = row.insertCell(2);
              var numberLink = document.createElement('a');
              var createdAtLink = document.createElement('a');
              var descriptionLink = document.createElement('a');

              numberLink.href = 'https://myda.space/' + DATA.root + '?v=' + version.version;
              createdAtLink.href = 'https://myda.space/' + DATA.root + '?v=' + version.version;
              descriptionLink.href = 'https://myda.space/' + DATA.root + '?v=' + version.version;

              numberLink.appendChild(document.createTextNode(version.version));
              createdAtLink.appendChild(document.createTextNode(version.createdAt));
              descriptionLink.appendChild(document.createTextNode(version.versionDescription || ''));

              number.appendChild(numberLink);
              createdAt.appendChild(createdAtLink);
              description.appendChild(descriptionLink);
            }
          }, function() {

          });
        });

        // Load data for root and render it on the page
        Mydataspace.request('entities.get', MDSCommon.extend(DATA, {
          path: 'views',
          children: true,
          limit: 1
        })).then(function(result) {
          var $lookWrap = $('#root__about__look_wrap');
          var $look = $('#root__about__look');

          if (result.children.length > 0) {
            $lookWrap.css('display', 'block');
            var lookMetaData = result.children[0];
            var type = MDSCommon.findValueByName(lookMetaData.fields, 'type');
            $('#root__about__look_title').text(MDSCommon.findValueByName(lookMetaData.fields, 'title'));
            $('#root__about__look_icon').attr('class', 'fa fa-' + type);
            $look.attr('class', 'root__about__look root__about__look--' + type);

            switch (type) {
              case 'codepen':
                var codepenParts = MDSCommon.findValueByName(lookMetaData.fields, 'id').split('/');
                $look.html('<p data-height="402" data-theme-id="0" data-slug-hash="' + codepenParts[1] +
                                             '" data-default-tab="result" data-user="'+ codepenParts[0] +
                                             '" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/' +  codepenParts[0] +
                                             '/pen/' + codepenParts[1] + '/">' + codepenParts[1] +
                                             '</a> by My Data Space (<a href="http://codepen.io/mydataspace">@mydataspace</a>) on <a href="http://codepen.io">CodePen</a>.</p>');

                var codepenScript = document.createElement('script');
                codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
                $lookWrap.append(codepenScript);
                break;
              case 'table':
                $look.html('');
                Mydataspace.request('entities.get', MDSCommon.extend(DATA, { path: lookMetaData.path + '/columns', children: true })).then(function(columnsMetaData) {
                  var columns = columnsMetaData.children.map(function(column) {
                    return {
                      id: MDSCommon.getPathName(column.path),
                      header: [MDSCommon.findValueByName(column.fields, 'title'), {
                        content: 'serverFilter',
                        css: 'root__looks__table_header'
                      }],
                      width: parseInt(MDSCommon.findValueByName(column.fields, 'width')) || 200,
                      sort: 'server'
                    };
                  });
                  columns.push({
                    header: '',
                    fillspace: true
                  });
                  webix.ui({
                    container: 'root__about__look',
                    rows: [
                      { padding: 3,
                        css: 'root__about__look_search',
                        cols: [
                          { view: 'search',
                            icon: 'search',
                            placeholder: 'Search...',
                            id: 'root__about__look_search',
                            on: {
                              onTimedKeyPress: function(code, e) {
                                $$('root__about__look').define('search', this.getValue());
                                $$('root__about__look').load('look->');
                              }
                            }
                          }
                        ]
                      },
                      { view: 'datatable',
                        borderless: true,
                        id: 'root__about__look',
                        css: 'root__about__look_webix',
                        columns: columns,
                        select: 'row',
                        resizeColumn: true,
                        headerRowHeight: 40,
                        navigation: true,
                        datafetch: 40,
                        loadahead: 20,
                        autoheight: true,
                        minHeight: 430,
                        clipboard: 'selection',
                        lookMetaData: lookMetaData,
                        columnsMetaData: columnsMetaData,
                        DATA: DATA,
                        url: 'look->',
                        pager: 'root__about__look_pager',
                        on: {
                          onColumnResize: function(id, newWidth, oldWidth, user_action) {
                            if (!user_action) {
                              return;
                            }
                            Mydataspace.request('entities.change', MDSCommon.extend(DATA, {
                              path: lookMetaData.path + '/columns/' + id,
                              fields: [
                                { name: 'width', value: newWidth, type: 'i' }
                              ]
                            })).catch(function() {});
                          }
                        }
                      },
                      { css: 'root__about__look_pager_wrap',
                        cols: [
                          { view: 'pager',
                            id: 'root__about__look_pager',
                            size: 12,
                            group: 5,
                            height: 40,
                            css: 'root__about__look_pager',
                            animate: {
                              direction: 'top'
                            }
                          }
                        ]
                      }
                    ]
                  });
                });
                break;
            }
          }
        });

      });
    }

    //
    // Likes & comments
    //

    Mydataspace.emit('entities.subscribe', MDSCommon.extend(DATA, {
      path: 'comments/*'
    }));

    Mydataspace.emit('entities.subscribe', MDSCommon.extend(DATA, {
      path: 'likes/*'
    }));

    Mydataspace.emit('entities.subscribe', MDSCommon.extend(DATA, {
      path: 'views/*'
    }));

    Mydataspace.on('entities.create.res', function(data) {
      if (/^likes\//.test(data.path)) {
        document.getElementById('root__counters_likes_count').innerText =
          parseInt(document.getElementById('root__counters_likes_count').innerText) + 1;
        if (data.mine) {
          setMyLike(data);
        }
      } else if (/^comments\//.test(data.path)) {
        document.getElementById('root__tabs_comments_count').innerText =
          parseInt(document.getElementById('root__tabs_comments_count').innerText) + 1;
        document.getElementById('root__counters_comments_count').innerText =
          parseInt(document.getElementById('root__counters_comments_count').innerText) + 1;

        // if comment is not exists already
        if (document.getElementById(data.path) == null) {
          if (document.getElementById('root__comments').style.display === 'block') {
            var commentHTML = getCommentHTML(data);
            $('#root__comments__list').append(commentHTML);
            document.getElementById('root__comments__empty').style.display = 'none';
          }
        }
      } else if (/^views\/[^\/]*$/.test(data.path)) {
        $('#root__looks__previews').append(getLookPreviewHTML(data));
        var preview = getLookPreviewNode(data.path);
        switch (MDSCommon.findValueByName(data.fields, 'type')) {
          case 'codepen':
            var codepenScript = document.createElement('script');
            codepenScript.setAttribute('src', 'https://assets.codepen.io/assets/embed/ei.js');
            preview.appendChild(codepenScript);
            break;
          case 'table':
            break;
        }
        $(preview).data('look-data', data);
        var viewsCount = parseInt(document.getElementById('root__tabs_views_count').innerText);
        document.getElementById('root__tabs_views_count').innerText = viewsCount + 1;
        if (viewsCount === 0) {
          document.getElementById('root__looks__empty').style.display = 'none';
        }
      }
    });

    Mydataspace.on('entities.delete.res', function(data) {
      if (/^likes\//.test(data.path)) {
        document.getElementById('root__counters_likes_count').innerText =
          parseInt(document.getElementById('root__counters_likes_count').innerText) - 1;
        resetMyLike(data);
      } else if (/^comments\//.test(data.path)) {
        document.getElementById('root__tabs_comments_count').innerText =
          parseInt(document.getElementById('root__tabs_comments_count').innerText) - 1;
        document.getElementById('root__counters_comments_count').innerText =
          parseInt(document.getElementById('root__counters_comments_count').innerText) - 1;

        var comment = document.getElementById(data.path);
        if (comment != null) {
          comment.parentNode.removeChild(comment);
          if (document.getElementById('root__comments__list').children.length === 0) {
            document.getElementById('root__comments__empty').style.display = 'block';
          }
        }
      } else if (/^views\/[^\/]*$/.test(data.path)) {
        $(getLookPreviewNode(data.path)).parent().remove();

        var viewsCount = parseInt(document.getElementById('root__tabs_views_count').innerText);
        document.getElementById('root__tabs_views_count').innerText = viewsCount - 1;
        if (viewsCount <= 1) {
          document.getElementById('root__looks__empty').style.display = 'block';
          document.getElementById('root__looks__content_wrap').style.display = 'none';
          $('body').css('overflow', '');
        } else {
          if (currentLook.path === data.path) {
            selectLook();
          }
        }
      }
    });

    function setMyLike(data) {
      document.getElementById('root__counters_likes').setAttribute('data-like-path', data.path);
      document.getElementById('root__counters_likes').classList.add('root_counter--active');
    }

    function resetMyLike(data) {
      var path = document.getElementById('root__counters_likes').getAttribute('data-like-path');
      if (MDSCommon.isPresent(path) && (MDSCommon.isBlank(data) || data.path === path)) {
        document.getElementById('root__counters_likes').removeAttribute('data-like-path');
        document.getElementById('root__counters_likes').classList.remove('root_counter--active');
      }
    }

    function requestMyLike() {
      Mydataspace.request('entities.getMyChildren', MDSCommon.extend(DATA, { path: 'likes' })).then(function(result) {
        var children = result.children;
        if (children.length > 0) {
          setMyLike(children[0]);
        } else {
          resetMyLike();
        }
      });
    }

    $('#look_modal__table_reset').click(function() {
      refreshLookTableColumns();
    });
    $('#look_modal__table_remove').click(function() {
      $$('look_modal__table').remove($$('look_modal__table').getSelectedId(true));
    });
    $('#look_modal__table_add').click(function() {
      var id = $$('look_modal__table').add({ value: '', title: '', width: 200 });
      $$('look_modal__table').editCell(id, 'value');
    });

    function refreshLookTableColumns() {
      $$('look_modal__table').clearAll();
      Mydataspace.entities.get(MDSCommon.extend(DATA, {
        path: $('#look_modal__table_path').val(),
        children: true
      })).then(function(data) {
        var child = data.children[0];
        var formattedData = child.fields.filter(function(field) {
          return field.name.indexOf('$') !== 0;
        }).map(function(field) {
          return {
            value: field.name,
            title: field.name,
            width: 200
          }
        });
        $$('look_modal__table').parse(formattedData);
      });
    }
    var lastKeypressTime;
    $('#look_modal__table_path').keydown(function() {
      lastKeypressTime = new Date().getTime();
    });
    setInterval(function() {
      var now = new Date().getTime();
      if (lastKeypressTime && now - lastKeypressTime > 500) {
        lastKeypressTime = null;
        refreshLookTableColumns();
      }
    }, 200);
  })();
</script>
