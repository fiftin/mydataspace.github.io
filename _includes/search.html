<div class="navbar-form navbar-left header__search_wrap" id="{{include.id}}">
  <div class="form-group" id="{{include.id}}_input_wrap">
    <input id="{{include.id}}_input"
           type="text"
           class="form-control header__search_input"
           placeholder="{{ site.data[page.language].header.input_search }}"
           spellcheck="false"
    />
  </div>

  <script type="text/javascript">
    var TAGS_TO_FILTERS = {
      lang: 'language',
      ctry: 'country',
      cat: 'category',
      src: 'datasource'
    };

    function search_parseQuery() {
      var ret = '';
      var params = MDSCommon.parseQuery(window.location.search);
      if (MDSCommon.isPresent(params.tags)) {
        var tags = params.tags.split(',');
        tags.forEach(function(tag) {
          if (tag[0] !== '@') {
            ret += '#';
          }
          ret += tag + ' ';
        });
      }
      if (MDSCommon.isPresent(params.q)) {
        ret += params.q;
      }

      return ret;
    }

    function search_parseSearchString(search) {

      var tags = [];
      var newSearch = '';
      var filters = {};
      var parts = search.split(/\s+/);
      for (var i in parts) {
        var part = parts[i];
        if (part[0] === '#') {
          var filter2val = part.split(':');
          if (filter2val.length === 1) {
            tags.push(part.substring(1));
          } else {
            filter = TAGS_TO_FILTERS[filter2val[0].substring(1)];
            if (filter) {
              filters[filter] = filter2val[1];
            }
          }
        } else {
          if (newSearch !== '') {
            newSearch += ' ';
          }
          newSearch += part;
        }
      }

      return {
        search: newSearch,
        filters: filters,
        tags: tags
      }
    }

    function search_getQueryFromSearchString(search) {
      var options = search_parseSearchString(search);
      var ret = '';
      for (var filter in options.filters) {
        if (ret === '') {
          ret += 'tags='
        } else {
          ret += ','
        }
        ret += filter + ':' + options.filters[filter];
      }

      options.tags.forEach(function(tag) {
        if (ret === '') {
          ret += 'tags='
        } else {
          ret += ','
        }
        ret += tag;
      });

      if (MDSCommon.isPresent(options.search)) {
        if (ret !== '') {
          ret += '&'
        }

        ret += 'q=' + options.search;
      }

      if (ret === '') {
        return '';
      }
      return '?' + ret;
    }

    var search_{{include.id}}_url = '';

    if (MDSCommon.endsWith(window.location.pathname, '/search')) {
      document.getElementById('{{include.id}}_input').classList.add('header__search_input--focus');
      document.getElementsByClassName('smoke')[0].classList.add('smoke--fullscreen--opaque');
      document.getElementById('{{include.id}}_input').value = search_parseQuery();
      document.getElementById('{{include.id}}_input').setAttribute('placeholder', '{{ site.data[page.language].header.input_search_fixed }}');
    }

    var isAdmin_{{include.id}} = {{include.admin}};

    function closeSearch_{{include.id}}() {
      document.getElementById('{{include.resultContainer}}').style.display = 'none';
      if (isAdmin_{{include.id}}) {
        document.getElementById('webix_preloaded_header').classList.remove('webix_preloaded_header--top');
        document.getElementById('admin_panel').classList.remove('admin_panel--fullscreen');
      } else {
        document.getElementsByTagName('body')[0].classList.remove('body_fixed');
        var header = document.getElementById('header');
        if (header) {
          header.style.display = 'block';
        }

        document.getElementsByClassName('smoke')[0].classList.remove('smoke--fullscreen');
        document.getElementsByClassName('navbar')[0].classList.remove('navbar--fixed');
        var default_main = document.getElementsByClassName('default_main')[0];
        if (default_main) {
          default_main.classList.remove('default_main--fullscreen');
        }
        document.getElementById('search').classList.remove('search--fullscreen');
        if (document.getElementById('page_footer')) {
          document.getElementById('page_footer').classList.remove('footer--fullscreen');
        }
      }
    }

    function openSearch_{{include.id}}(search, nonHiddable) {
      if (search == null) {
        search = search_parseQuery();
        document.getElementById('{{include.id}}_input').value = search_parseQuery();
      }

      document.getElementById('{{include.id}}_input').value = search;
      document.getElementById('{{include.id}}_input').focus();

      startSearch_{{include.id}}(search, nonHiddable);
    }

    function removeSearchPart_{{include.id}}(part) {
      var search = document.getElementById('{{include.id}}_input').value;
      var newSearch = search.replace(part, '').replace(/^\s+/, '').replace(/\s+/, ' ').trim();
      if (newSearch !== '') {
        newSearch += ' ';
      }
      openSearch_{{include.id}}(newSearch);
    }

    function setSearchPart_{{include.id}}(part) {
      var search = document.getElementById('{{include.id}}_input').value;
      if (part[0] !== '#') { // search string
        search += part;
      } else {
        var prefix = part.split(':')[0];
        if (prefix === part) { // tag
          if (search.indexOf(part) < 0) {
            search += ' ' + part;
          }
        } else { // filter
          var newSearch = search.replace(new RegExp(prefix + ':[^\\s#]\\b'), part);
          if (search === newSearch) {
            if (MDSCommon.isPresent(search)) {
              search += ' ';
            }
            search += part;
          } else {
            search = newSearch;
          }
        }
      }
      openSearch_{{include.id}}(search);
    }

    function startSearch_{{include.id}}(search, nonHiddable) {

      var CATEGORY_ICONS = {
        biz: 'briefcase',
        economy: 'area-chart',
        health: 'heart',
        edu: 'graduation-cap',
        ecology: 'leaf',
        culture: 'paint-brush',
        security: 'shield',
        transport: 'car',
        geo: 'map',
        state: 'university',
        tourism: 'plane'
      };

      var searchOptions = search_parseSearchString(search);
      var filters = searchOptions.filters;

      // Try to get roots from server
      Mydataspace.request('entities.getRoots', {
        search: searchOptions.search,
        profiles: true,
        filter: searchOptions.filters
      }, function(data) {
        var rootsHtml = data.roots.map(function(root) {
          var avatar = MDSCommon.findValueByName(root.fields, 'avatar');
          if (MDSCommon.isBlank(avatar)) {
            avatar = '/images/icons/root.svg';
          } else {
            avatar = 'https://cdn.mydataspace.net/avatars/sm/' + avatar + '.png';
          }

          var tags = (MDSCommon.findValueByName(root.fields, 'tags') || '').split(' ').filter(function(tag) {
            return tag != null && tag != '';
          }).map(function(tag) {
            return '<span class="view__tag" onclick="openSearch_{{include.id}}(\'' + tag + '\'); return false;">' + tag + '</span>';
          }).join(' ');

          var languageAbbr = MDSCommon.findValueByName(root.fields, 'language');
          var countryAbbr = MDSCommon.findValueByName(root.fields, 'country');
          var category = MDSCommon.findValueByName(root.fields, 'category');

          var country = COUNTRIES[countryAbbr];
          var language = COUNTRIES[languageAbbr];


          if (category) {
            tags = '<span class="view__tag" onclick="openSearch_{{include.id}}(\'#cat:' + category + '\'); return false;"><i class="view__tag_icon fa fa-' + CATEGORY_ICONS[category] + '"></i><span>' + tr$('categories.' + category) + '</span></span> ' + tags;
          }


          if (country && (languageAbbr === countryAbbr || (language.same || []).indexOf(countryAbbr) != -1)) {
            tags = '<span class="view__tag view__tag--icon" style="background-image: url(/images/square_flags/' + country.name +
              '.svg)">&nbsp;</span><span class="view__tag view__tag--with-icon">' +
              tr$('languagesShort.' + languageAbbr) + ' / ' + tr$('countries.' + countryAbbr) + '</span> ' + tags;
          } else {
            if (country) {
              tags = '<span class="view__tag view__tag--icon" style="background-image: url(/images/square_flags/' + country.name + '.svg)">&nbsp;</span><span class="view__tag view__tag--with-icon" onclick="openSearch_{{include.id}}(\'#ctry:' + countryAbbr + '\'); return false;">' + tr$('countries.' + countryAbbr) + '</span> ' + tags;
            }

            if (language) {
              tags = '<span class="view__tag view__tag--icon" style="background-image: url(/images/square_flags/' + language.name + '.svg)">&nbsp;</span><span class="view__tag view__tag--with-icon" onclick="openSearch_{{include.id}}(\'#lang:' + languageAbbr + '\'); return false;">' + tr$('languagesShort.' + languageAbbr) + '</span> ' + tags;
            }
          }


          var nLikes = MDSCommon.findValueByName(root.fields, '$likes') || 0;
          var nComments = MDSCommon.findValueByName(root.fields, '$comments') || 0;

          var languageMatch = location.pathname.match(/^\/(\w\w)(\/.*)?$/);

          var lang = languageMatch ? languageMatch[1] + '/' : '';

          var footer;

          if (root.profile && data.profiles[root.profile]) {
            var authorAvatar = 'https://cdn.mydataspace.net/avatars/sm/' + (data.profiles[root.profile].avatar || 'HJYrGU87W') + '.png';
            footer =
              '<div class="snippet__author">' +
              '  <img class="snippet__author_avatar" src="' + authorAvatar + '" />' +
              '  <span class="snippet__author_name">' + data.profiles[root.profile].name + '</span>' +
              (data.profiles[root.profile].verified ? '<i class="fa fa-check snippet__author_verified" aria-hidden="true"></i>' : '') +
              '</div>'; 
          } else {
            footer = 
              '<div class="snippet__date view__comment__date view__date_wrap">' +
              '  ' + tr$('created') + ' <span class="view__date" id="view__date">' + MDSCommon.humanizeDate(root.createdAt) + '</span> ' + tr$('ago') +
              '</div>'; 
          }

          return '<div class="col-md-6"><a class="block snippet clearfix" href="/' + lang + root.root + '">\n' +
            '  <div class="snippet__overview">\n' +
            '  <img class="snippet__image" src="' + avatar + '" />\n' +
            '  <div class="snippet__info' + (MDSCommon.isBlank(tags) ? ' snippet__info--small' : '') + '">\n' +
            '    <div class="snippet__title">' + (MDSCommon.findValueByName(root.fields, 'name') || root.root) + '</div>\n' +
            '    <div class="snippet__tags">' +
            (tags || '') +
            '    </div>\n' +
            '</div>\n' + // info

            '</div>\n' + // overview
            '  <div class="snippet__description">' + (MDSCommon.findValueByName(root.fields, 'description') || '') + '</div>\n' +

            '<div class="snippet__footer">' +
            footer +
            '<div class="snippet__counters">' +
            '<span class="root_counter"><i class="fa fa-heart" aria-hidden="true"></i><span class="root_counter__count root_counter__count--likes">' + nLikes + '</span></span>' +
            '<span class="root_counter"><i class="fa fa-comments" aria-hidden="true"></i><span class="root_counter__count">' + nComments + '</span></span>' +
            '</div>' +

            '</div>' + // footer

            '</a></div>';
        });
        
        function getFilterHTML(items, itemTitlesCollection, prefix, filters, opts) {
          var options = MDSCommon.extend({
            translate: true,
            facetIconClass: null,
            facetIconMap: null
          }, opts);
          var filter = TAGS_TO_FILTERS[prefix];
          var title = tr$(filter);
          if (MDSCommon.isBlank(items)) {
            return '';
          }

          var filtersHTML = items.map(function(facet) {
            if (filters[filter] && filters[filter] !== facet.name) {
              return '';
            }
            var active = filters[filter] === facet.name;
            var classes = active ? 'search_filter__item--active' : '';
            var action = active ? 'remove' : 'set';
            var title = options.translate ? tr$(itemTitlesCollection + '.' + facet.name) : facet.name;
            if (!title) {
              return '';
            }
            var iconHTML;
            if (options.facetIconClass) {
              var iconClassSuffix = options.facetIconMap ? options.facetIconMap[facet.name] : facet.name;
              iconHTML = '<i class="' + options.facetIconClass + iconClassSuffix + '"></i>';
            } else {
              iconHTML = '';
            }


            return '<a href="javascript:void(0)" onclick="' + action + 'SearchPart_{{include.id}}(\'#' + prefix + ':' + facet.name + '\')" class="search_filter__item ' + classes + '">' +
              iconHTML +
              '<span class="search_filter__item_title">' + title + '</span>' +
              '<span class="search_filter__item_count">' + facet.count + '</span>' +
              '<i class="search_filter__item_remove fa fa-remove"></i>' +
              '</a>';
          }).join('');

          return '<div class="search_filter">' +
            '<div class="search_filter__title">' + title + '</div>' +
            '<div class="search_filter__items">' + filtersHTML + '</div>' +
          '</div>';
        }

        document.getElementById('{{include.resultContainer}}').innerHTML =
          rootsHtml.length > 0 ?
            '<div class="container search__content">' +
              '<div class="search__results">' +
                '<div class="search__header clearfix">' +
                  '<div class="search__found_count">Found ' + data.roots.length + ' root(s)</div>' +
                  '<div class="btn-group search__display_modes" role="group">' +
                    '<button type="button" class="btn btn-default"><i class="fa fa-list"></i></button>' +
                    '<button type="button" class="btn btn-default active"><i class="fa fa-th-large"></i></button>' +
                  '</div>' +
                '</div>' +
                '<div class="row">' + rootsHtml.join('\n') + '</div>' +
              '</div>' +
              '<div class="search__filter_panel_wrap">' +
                '<div class="search__filter_panel">' +
                  getFilterHTML(data.facets.language, 'languages', 'lang', filters, { facetIconClass: 'search_filter__icon flag-icon flag-icon-' }) +
                  getFilterHTML(data.facets.country, 'countries', 'ctry', filters, { facetIconClass: 'search_filter__icon flag-icon flag-icon-' }) +
                  getFilterHTML(data.facets.category, 'categories', 'cat', filters, {
                    facetIconClass: 'search_filter__icon fa fa-',
                    facetIconMap: CATEGORY_ICONS
                  }) +
                '</div>' +
              '</div>' +
            '</div>' : '';
      }, function(err) {
        console.log(err);
      });
    }

    //
    // Show suggestions when search input focused
    document.getElementById('{{include.id}}_input').addEventListener('focus', function() {
      if (window.location.pathname !== '/search') {
        search_{{include.id}}_url = window.location.href;
      }

      history.replaceState({ search: document.getElementById('{{include.id}}_input').value }, 'Search', '/search' + search_getQueryFromSearchString(document.getElementById('{{include.id}}_input').value));

      document.getElementById('{{include.resultContainer}}').style.display = 'block';
      if (isAdmin_{{include.id}}) {
        document.getElementById('webix_preloaded_header').classList.add('webix_preloaded_header--top');
        document.getElementById('admin_panel').classList.add('admin_panel--fullscreen');
      } else {
        document.getElementsByTagName('body')[0].classList.add('body_fixed');
        var header = document.getElementById('header');
        if (header) {
          header.style.display = 'none';
        }
        document.getElementsByClassName('smoke')[0].classList.add('smoke--fullscreen');
        document.getElementsByClassName('navbar')[0].classList.add('navbar--fixed');
        var default_main = document.getElementsByClassName('default_main')[0];
        if (default_main) {
          default_main.classList.add('default_main--fullscreen');
        }
        document.getElementById('search').classList.add('search--fullscreen');
        if (document.getElementById('page_footer')) {
          document.getElementById('page_footer').classList.add('footer--fullscreen');
        }
      }
      startSearch_{{include.id}}(document.getElementById('{{include.id}}_input').value);
    });

    //
    // Filter suggestions when search input text changed
    document.getElementById('{{include.id}}_input').addEventListener('keyup', function(event) {
      var url1 = search_{{include.id}}_url.split('?')[0];
      var url2 = window.location.href.split('?')[0];

      if (event.keyCode === 27 && url1 !== '' && url1 != url2) {
        closeSearch_{{include.id}}();
        document.getElementById('{{include.id}}_input').blur();
        history.replaceState({}, '', search_{{include.id}}_url);
        document.getElementById('{{include.id}}_input').value = '';
        return;
      }
      history.replaceState({}, '', '/search' + search_getQueryFromSearchString(document.getElementById('{{include.id}}_input').value));
      startSearch_{{include.id}}(document.getElementById('{{include.id}}_input').value);
    }, false);

    if (isAdmin_{{include.id}}) {
      window.addEventListener('hashchange', function() {
        closeSearch_{{include.id}}();
      }, false);
    }
  </script>
</div>
