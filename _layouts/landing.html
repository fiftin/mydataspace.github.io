<!DOCTYPE html>
<html>

  {% include head.html webix=true %}

  <body>
    <div id="bootstrap" class="landing landing--{{ page.language }}">
      <script type="text/javascript">
        if (isValidJWT(localStorage.getItem('authToken')) ||
            window.location.hash && window.location.hash !== '' && window.location.hash !== '#') {
          document.getElementById('bootstrap').style.display = 'none';
        }
      </script>

      <div class="page_top">
        <div class="smoke">
          {% include nav.html %}
          {% include header.html %}
        </div>
      </div>

      {% include favorite_snippets.html %}

      <div class="mission">
          <div class="container">{{ site.data[page.language].mission }}</div>
      </div>

      {% include feature_sections.html %}
      {% include sub_footer.html %}
      {% include footer.html %}
    </div>

    {% include signin_modal.html %}

    <div id="webix">
      <script type="text/javascript">
        if (!isValidJWT(localStorage.getItem('authToken')) &&
            !(window.location.hash && window.location.hash !== '' && window.location.hash !== '#')) {
          document.getElementById('webix').style.display = 'none';
        }
      </script>


      <div class="webix_preloaded_header invisible" id="webix_preloaded_header"></div>

      <a class="logo invisible" href="/" id="logo_link">
        <div class="logo__img_wrap">
          <img src="/images/logo_128.png" class="logo__img" />
        </div>
        <img src="/images/logo_text.svg" class="logo__text_img hidden-xs" />
      </a>


      <div id="admin_panel__loading"><i class="fa fa-cog fa-spin fa-fw"></i></div>

      <div id="no_items" class="no_items invisible">
        <div id="no_items__no_apps"></div>

        <div class="no_items__content" id="no_items__no_data">
          <div class="container">
            <div id="no_items__title" class="no_items__no_apps"></div>
            <!--<div class="no_items__no_apps_description">-->
              <!--Create empty root, import data from file or explore existing roots with using-->
              <!--useful search-->
            <!--</div>-->
            <div class="row">

              <!-- Explore -->
              <div class="col-xs-4 no_items__column">
                <div id="no_items__explore__desc" class="no_items__desc"></div>
                <div class="no_items__roots clearfix">
                  <img src="https://api.mydataspace.net/avatars/sm/Hk3L6-itg.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/B1VWVnOnl.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/HkuFL3o2x.png" class="no_items__root" />
                  <img src="https://cdn.mydataspace.net/avatars/sm/BJMK_ni2e.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/Sy2jU2jhg.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/Skblwho3x.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/rymJD3o3e.png" class="no_items__root" />
                  <img src="https://api.mydataspace.net/avatars/sm/SyNT83jhg.png" class="no_items__root" />
                </div>
                <a href="/#*"
                   class="btn btn-default btn-lg no_items__btn no_items__btn--bottom"
                   id="no_items__explore__button"></a>
              </div>

              <!-- Import -->
              <div class="col-xs-4 no_items__column">
                <div id="no_items__import__desc" class="no_items__desc"></div>

                <img class="no_items__refine_img" src="/images/openrefine.png" />

                <div class="no_items__import" id="no_items__import__refine_desc"></div>

                <button class="btn btn-primary btn-lg no_items__btn no_items__btn--bottom"
                        data-toggle="modal"
                        data-target="#import_data_modal" id="no_items__import__button"></button>

              </div>

              <!-- Create -->
              <div class="col-xs-4 no_items__column">
                <div id="no_items__create__desc" class="no_items__desc"></div>
                <div class="no_items__center no_items__center--right">
                  <input id="no_items__new_root_input"
                         type="text"
                         class="no_items__new_root_input form-control"
                         onkeypress="no_items__new_root_input__onKeyPress(event)"
                         placeholder="Root Name"
                         id="no_items__create__input" />

                  <div id="no_items__notice" class="no_items__notice"></div>
                </div>

                <button class="btn btn-success btn-lg no_items__btn no_items__btn--bottom"
                        onclick="no_items__createNewRoot()"
                        id="no_items__create__button"></button>

                <script>
                  function no_items__createNewRoot() {
                    document.getElementById('no_items__notice').classList.remove('no_items__notice--alert');
                    var root = document.getElementById('no_items__new_root_input').value;
                    Mydataspace.request('entities.create', {
                      root: root,
                      path: '',
                      fields: []
                    }, function() {
                      document.getElementById('no_items__new_root_input').value = '';
                    }, function(err) {
                      switch (err.name) {
                        case 'SequelizeUniqueConstraintError':
                          document.getElementById('no_items__notice').classList.add('no_items__notice--alert');
                          document.getElementById('no_items__new_root_input').focus();
                          break;
                        default:
                      }
                    });
                  }

                  function no_items__new_root_input__onKeyPress(e) {
                    if (e.keyCode === 13) {
                      no_items__createNewRoot();
                      return false;
                    }
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="admin_panel" class="admin_panel invisible"></div>

      {% include search.html id="webix__header__search" admin=true resultContainer="webix_search" %}

      <div id="webix_search"></div>
    </div>

    <script src="/vendor/jquery.min.js"></script>

    <script type="text/javascript">
      var adminPanel_waiting  = false;
      function adminPanel_startWaiting(duration) {
        if (adminPanel_waiting) {
          return;
        }
        adminPanel_waiting = true;
        $('#admin_panel__loading').show();
        $('#webix_preloaded_header').addClass('invisible');
        $('#logo_link').addClass('invisible');
        $('#no_items').addClass('invisible');
        $('#admin_panel').addClass('invisible');

        setTimeout(function() {
          adminPanel_waiting = false;
          $('#admin_panel__loading').hide();
          $('#webix_preloaded_header').removeClass('invisible');
          $('#logo_link').removeClass('invisible');
          $('#no_items').removeClass('invisible');
          $('#admin_panel').removeClass('invisible');
        }, duration);
      }

      adminPanel_startWaiting(2500);
    </script>

    <script src="/js/dist/api-v2.js" type="text/javascript"></script>
    <script src="/vendor/bootstrap/bootstrap.min.js"></script>
    <script src="/vendor/webix/webix_debug.js"></script>
    <script src="/skins/flat/skin.js"></script>
    <script src="/vendor/remarkable.js"></script>
    <script src="/js/dist/ui.js"></script>
    <script>
      $(function() {
        // Get Started large button
        $('#sub_footer__button').popover({
          placement: 'top',
          html : true,
          trigger: 'focus',
          content: function() {
            return $('#signin_popover').html();
          }
        });
        $('#import_data_modal').on('show.bs.modal', function () {
          document.getElementById('import_data_modal__refine').src = '{{ refine_url }}';
        });

      });

      window.addEventListener('message', function(e) {
        if (e.data.message === 'openRefineImport') {
          switch (e.data.stage) {
            case 'getTargetEntity':
              e.source.postMessage({
                message: 'targetEntity',
                openRefineImportEntity: typeof openRefineImportEntity === 'undefined' ? {} : openRefineImportEntity

              }, '*');        
              if (typeof openRefineImportEntity !== 'undefined') {
                delete openRefineImportEntity;
              }
              break;
            case 'finished':
              $('#import_data_modal').modal('hide');
              UI.entityTree.refresh();
              if (typeof openRefineImportEntity !== 'undefined') {
                delete openRefineImportEntity;
              }
              //if (Identity.dataFromId(UI.entityTree.getCurrentId).root !== e.data.root) {
              //  UI.entityTree.setCurrentId(Identity.idFromData({ root: e.data.root, path: '' }));
              //} else {
              //  UI.entityList.refreshData();
              //}
              break;
            case 'created': // Open Refine finished his work
              document.getElementById('import_data_modal__refine').src = '/finish-import.html?id=' + e.data.id;
              break;
          }
        }
      });



      $(window).on('hashchange', function() {
        var isEmptyHash = window.location.hash == null ||
                          window.location.hash === '' ||
                          window.location.hash === '#';
        if (!isEmptyHash && document.getElementById('webix').style.display === 'none') {
          document.getElementById('bootstrap').style.display = 'none';
          document.getElementById('webix').style.display = 'block';
        }
      });

      //
      // Init MyDataSpace
      //

      webix.codebase = "/vendor/";
      Mydataspace = new Myda({
        apiURL: '{{ api_url }}',
        websocketURL: '{{ api_websocket_url }}',
        clientId: '{{ client_id }}',
        permission: 'admin',
        simpleFormat: false,
        connected: function() {
          UI.initConnection();
          if (!isValidJWT(localStorage.getItem('authToken'))) {
              // UI.refresh();
              UI.pages.refreshPage('data', true);
          }
        }
      });
      Mydataspace.authProviders.facebook.title = STRINGS.CONNECT_TO_FACEBOOK;
      Mydataspace.authProviders.google.title = STRINGS.CONNECT_TO_GOOGLE;
      UI.render('admin_panel');
      Mydataspace.connect();

      //
      // Init Markdown renderer
      //
      var md = new Remarkable({
        html:         true,        // Enable HTML tags in source
        xhtmlOut:     false,        // Use '/' to close single tags (<br />)
        breaks:       false,        // Convert '\n' in paragraphs into <br>
        langPrefix:   'language-',  // CSS language prefix for fenced blocks
        linkify:      false,        // Autoconvert URL-like text to links

        // Enable some language-neutral replacement + quotes beautification
        typographer:  false,

        // Double + single quotes replacement pairs, when typographer enabled,
        // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
        quotes: '“”‘’',

        // Highlighter function. Should return escaped HTML,
        // or '' if the source string is not changed
        highlight: function (/*str, lang*/) { return ''; }
      });
    </script>


    <div id="import_data_modal"
         class="modal"
         role="dialog"
         aria-labelledby="Importing Data">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <div class="modal-title">Importing Data</div>
          </div>
          <div class="modal-body">
            <iframe id="import_data_modal__refine" class="import_data_model__refine"></iframe>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
